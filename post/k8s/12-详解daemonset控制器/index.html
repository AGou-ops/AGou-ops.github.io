<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>12 详解DaemonSet控制器 - AGou's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="AGou-ops"><meta name=description content="写在前面 上章节中介绍了Deployment，ReplicaSet，ReplicationController等副本控制器的使用和场景，接下来"><meta name=keywords content="AGou,blog,阿狗,阿狗博客,阿狗的博客,AGou blog"><meta name=baidu-site-verification content="eS8otJ2dE7My4oKT"><meta name=generator content="Hugo 0.75.1"><link rel=canonical href=https://agou-ops.top/post/k8s/12-%E8%AF%A6%E8%A7%A3daemonset%E6%8E%A7%E5%88%B6%E5%99%A8/><link rel=icon type=image/x-ico href=https://s1.ax1x.com/2020/05/19/Y4cixe.png><link rel=stylesheet href=/sass/jane.min.b6beb05dbf2ff177150668722e41f1d9f8b97f730dc9e3423e87b0747659f697.css integrity="sha256-tr6wXb8v8XcVBmhyLkHx2fi5f3MNyeNCPoewdHZZ9pc=" media=screen crossorigin=anonymous><link rel=stylesheet href=/css/><meta property="og:title" content="12 详解DaemonSet控制器"><meta property="og:description" content="写在前面 上章节中介绍了Deployment，ReplicaSet，ReplicationController等副本控制器的使用和场景，接下来"><meta property="og:type" content="article"><meta property="og:url" content="https://agou-ops.top/post/k8s/12-%E8%AF%A6%E8%A7%A3daemonset%E6%8E%A7%E5%88%B6%E5%99%A8/"><meta property="article:published_time" content="2019-08-04T10:36:48+08:00"><meta property="article:modified_time" content="2019-08-04T10:36:48+08:00"><meta itemprop=name content="12 详解DaemonSet控制器"><meta itemprop=description content="写在前面 上章节中介绍了Deployment，ReplicaSet，ReplicationController等副本控制器的使用和场景，接下来"><meta itemprop=datePublished content="2019-08-04T10:36:48+08:00"><meta itemprop=dateModified content="2019-08-04T10:36:48+08:00"><meta itemprop=wordCount content="3475"><meta itemprop=keywords content="kubernetes,"><meta name=twitter:card content="summary"><meta name=twitter:title content="12 详解DaemonSet控制器"><meta name=twitter:description content="写在前面 上章节中介绍了Deployment，ReplicaSet，ReplicationController等副本控制器的使用和场景，接下来"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>AGou's blog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.top/>主页</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.top/post/>归档</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.top/tags/>标签</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.top/aboutme/>关于</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.top/anime/>Anime</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://d.agou-ops.top/ rel=noopener target=_blank>myDocs
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408 512.128C896 481.792 871.424 457.152 841.152 457.152z"/></svg></i></a></li><input size=15 maxlength=15 type=search class=docsearch-input placeholder="Search Here..."></ul></nav><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css integrity="sha256-LWdHSKWG7zv3DTpee8YAgoTfkj3gNkfauF624h4P2Nw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css integrity="sha256-Q9bBMw/rHRRag46GDWY84J3elDNc8JJjKXL9tIC4oe8=" crossorigin=anonymous><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><style>.fork-me-on-github{position:absolute;top:0;right:0;border:0}@media(max-width:1080px){.fork-me-on-github{display:none}}</style><a href=https://github.com/AGou-ops><img loading=lazy class=fork-me-on-github src=https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/forkme_right_gray_6d6d6d.svg data-recalc-dims=1 alt="Fork me on GitHub"></a><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>AGou's blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://agou-ops.top/>主页</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.top/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.top/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.top/aboutme/>关于</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.top/anime/>Anime</a></li><li class=menu-item><a class=menu-item-link href=http://d.agou-ops.top/ rel=noopener target=_blank>myDocs
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408 512.128C896 481.792 871.424 457.152 841.152 457.152z"/></svg></i></a></li><input size=15 maxlength=15 type=search class=docsearch-input placeholder="Search Here..."></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>12 详解DaemonSet控制器</h1><div class=post-meta><time datetime=2019-08-04 class=post-time>2019-08-04</time><div class=post-category><a href=https://agou-ops.top/categories/%E8%BD%AC%E8%BD%BD/>转载</a>
<a href=https://agou-ops.top/categories/kubernetes/>kubernetes</a>
<a href=https://agou-ops.top/categories/%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/>基础教程</a></div><span class=more-meta>3475 words</span>
<span class=more-meta>7 min read</span>
<span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Table of Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#11-daemonset简介>1.1 DaemonSet简介</a></li><li><a href=#12-daemonset定义>1.2 DaemonSet定义</a></li><li><a href=#13-滚动更新与回滚>1.3 滚动更新与回滚</a></li><li><a href=#14-daemonset调度>1.4 DaemonSet调度</a></li></ul></nav></div></div><div class=post-content><h1 id=写在前面><strong>写在前面</strong></h1><p>上章节中介绍了<a href=#>Deployment，ReplicaSet，ReplicationController</a>等副本控制器的使用和场景，接下来介绍<a href=#>kubernetes系列教程</a>控制器DaemonSet使用。</p><h1 id=1-daemonset控制器>1. DaemonSet控制器</h1><h2 id=11-daemonset简介>1.1 DaemonSet简介</h2><p>介绍DaemonSet时我们先来思考一个问题：相信大家都接触过监控系统比如zabbix，监控系统需要在被监控机安装一个agent，安装agent通常会涉及到以下几个场景：</p><ul><li>所有节点都必须安装agent以便采集监控数据</li><li>新加入的节点需要配置agent，手动或者运行脚本</li><li>节点下线后需要手动在监控系统中删除</li></ul><p>kubernetes中经常涉及到在node上安装部署应用，它是如何解决上述的问题的呢？答案是DaemonSet。DaemonSet守护进程简称DS，适用于在所有节点或部分节点运行一个daemon守护进程，如监控我们安装部署时网络插件kube-flannel和kube-proxy，DaemonSet具有如下特点：</p><ul><li>DaemonSet确保所有节点运行一个Pod副本</li><li>指定节点运行一个Pod副本，通过标签选择器或者节点亲和性</li><li>新增节点会自动在节点增加一个Pod</li><li>移除节点时垃圾回收机制会自动清理Pod</li></ul><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E8%AF%A6%E8%A7%A3DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8/1%20-%201620.jpg alt=DaemnonSet控制器></p><p>DaemonSet适用于每个node节点均需要部署一个守护进程的场景，常见的场景例如：</p><ul><li>日志采集agent，如fluentd或logstash</li><li>监控采集agent，如Prometheus Node Exporter,Sysdig Agent,Ganglia gmond</li><li>分布式集群组件，如Ceph MON，Ceph OSD，glusterd，Hadoop Yarn NodeManager等</li><li>k8s必要运行组件，如网络flannel，weave，calico，kube-proxy等</li></ul><p>安装k8s时默认在kube-system命名空间已经安装了有两个DaemonSet，分别为kube-flannel-ds-amd64和kube-proxy，分别负责flannel overlay网络的互通和service代理的实现，可以通过如下命令查看：</p><p>\1. 查看kube-system命令空间的DaemonSet列表，当前集群有三个node节点，所以每个DS会运行三个Pod副本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>ds</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> 
<span class=nx>NAME</span>                    <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>NODE</span> <span class=nx>SELECTOR</span>                   <span class=nx>AGE</span>
<span class=nx>kube</span><span class=o>-</span><span class=nx>flannel</span><span class=o>-</span><span class=nx>ds</span><span class=o>-</span><span class=nx>amd64</span>   <span class=mi>3</span>         <span class=mi>3</span>         <span class=mi>3</span>       <span class=mi>3</span>            <span class=mi>3</span>           <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span>   <span class=mi>46</span><span class=nx>d</span>
<span class=nx>kube</span><span class=o>-</span><span class=nx>proxy</span>              <span class=mi>3</span>         <span class=mi>3</span>         <span class=mi>3</span>       <span class=mi>3</span>            <span class=mi>3</span>           <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span>     <span class=mi>46</span><span class=nx>d</span>
</code></pre></td></tr></table></div></div><p>\2. 查看Pod的副本情况，可以看到DaemonSet在每个节点都运行一个Pod</p><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E8%AF%A6%E8%A7%A3DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8/1%20-%201620.jpg alt=img></p><h2 id=12-daemonset定义>1.2 DaemonSet定义</h2><p>DaemonSet的定义和Deployment定义使用相类似，需要定义apiVersion，Kind，metadata和spec属性信息，spec中不需要定义replicas个数，spec.template即定义DS生成容器的模版信息，如下是运行一个fluentd-elasticsearch镜像容器的daemon守护进程，运行在每个node上通过fluentd采集日志上报到ElasticSearch。</p><p>\1. 通过yaml文件定义DaemonSet</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>es</span><span class=o>-</span><span class=nx>daemonset</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>              <span class=err>#</span><span class=nx>api版本信息</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>DaemonSet</span>                  <span class=err>#</span><span class=nx>类型为DaemonSet</span>
<span class=nx>metadata</span><span class=o>:</span>                        <span class=err>#</span><span class=nx>元数据信息</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>        <span class=err>#</span><span class=nx>运行的命名空间</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>k8s</span><span class=o>-</span><span class=nx>app</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>logging</span>
<span class=nx>spec</span><span class=o>:</span>                          <span class=err>#</span><span class=nx>DS模版</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>tolerations</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>key</span><span class=o>:</span> <span class=nx>node</span><span class=o>-</span><span class=nx>role</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>master</span>
        <span class=nx>effect</span><span class=o>:</span> <span class=nx>NoSchedule</span>
      <span class=nx>containers</span><span class=o>:</span>            <span class=err>#</span><span class=nx>容器信息</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>quay</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>fluentd_elasticsearch</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>:</span><span class=nx>v2</span><span class=mf>.5.2</span>
        <span class=nx>resources</span><span class=o>:</span>          <span class=err>#</span><span class=nx>resource资源</span>
          <span class=nx>limits</span><span class=o>:</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>200</span><span class=nx>Mi</span>
          <span class=nx>requests</span><span class=o>:</span>
            <span class=nx>cpu</span><span class=o>:</span> <span class=mi>100</span><span class=nx>m</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>200</span><span class=nx>Mi</span>
        <span class=nx>volumeMounts</span><span class=o>:</span>      <span class=err>#</span><span class=nx>挂载存储</span><span class=err>，</span><span class=nx>agent需要到这些目录采集日志</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlog</span>
          <span class=nx>mountPath</span><span class=o>:</span> <span class=err>/var/log</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlibdockercontainers</span>
          <span class=nx>mountPath</span><span class=o>:</span> <span class=err>/var/lib/docker/containers</span>
          <span class=nx>readOnly</span><span class=o>:</span> <span class=kc>true</span>
      <span class=nx>terminationGracePeriodSeconds</span><span class=o>:</span> <span class=mi>30</span>
      <span class=nx>volumes</span><span class=o>:</span>            <span class=err>#</span><span class=nx>将主机的目录以hostPath的形式挂载到容器Pod中</span><span class=err>。</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlog</span>
        <span class=nx>hostPath</span><span class=o>:</span>
          <span class=nx>path</span><span class=o>:</span> <span class=err>/var/log</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlibdockercontainers</span>
        <span class=nx>hostPath</span><span class=o>:</span>
          <span class=nx>path</span><span class=o>:</span> <span class=err>/var/lib/docker/containers</span>
</code></pre></td></tr></table></div></div><p>DaemonSet定义注意事项：</p><ul><li>daemonset.spec.template定义Pod的模板信息，包含的metadata信息需要和selector保持一致</li><li>template必须定义RestartPolicy的策略，切策略值为Always，保障服务异常时能自动重启恢复</li><li>Pod运行在特定节点，支持指定调度策略，如nodeSelector，Node affinity，实现灵活调度</li></ul><p>\2. 生成DaemonSet</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>es</span><span class=o>-</span><span class=nx>daemonset</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>daemonset</span><span class=p>.</span><span class=nx>apps</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> <span class=nx>created</span>
</code></pre></td></tr></table></div></div><p>\3. 查看DaemonSet列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>daemonsets</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>  <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> 
<span class=nx>NAME</span>                    <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>NODE</span> <span class=nx>SELECTOR</span>   <span class=nx>AGE</span>
<span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>   <span class=mi>3</span>         <span class=mi>3</span>         <span class=mi>3</span>       <span class=mi>3</span>            <span class=mi>3</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>          <span class=mi>16</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>\4. 查看node上运行Pod的情况,在NODE列可以看到每个node都运行了一个Pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> <span class=o>|</span><span class=nx>grep</span> <span class=nx>fluentd</span> 
<span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span><span class=o>-</span><span class=nx>blpqb</span>      <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>3</span><span class=nx>m7s</span>   <span class=mf>10.244.2.79</span>      <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span><span class=o>-</span><span class=nx>ksdlt</span>      <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>3</span><span class=nx>m7s</span>   <span class=mf>10.244.0.11</span>      <span class=nx>node</span><span class=o>-</span><span class=mi>1</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span><span class=o>-</span><span class=nx>shtkh</span>      <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>3</span><span class=nx>m7s</span>   <span class=mf>10.244.1.64</span>      <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>\5. 查看DaemonSet详情，可以看到DaemonSet支持RollingUpdate滚动更新策略</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>daemonsets</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>yaml</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>DaemonSet</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span> <span class=o>|</span>
      <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;apps/v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;DaemonSet&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;labels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;k8s-app&#34;</span><span class=o>:</span><span class=s2>&#34;fluentd-logging&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;fluentd-elasticsearch&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;kube-system&#34;</span><span class=p>},</span><span class=s2>&#34;spec&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;selector&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;matchLabels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;fluentd-elasticsearch&#34;</span><span class=p>}},</span><span class=s2>&#34;template&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;labels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;fluentd-elasticsearch&#34;</span><span class=p>}},</span><span class=s2>&#34;spec&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;containers&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;image&#34;</span><span class=o>:</span><span class=s2>&#34;quay.io/fluentd_elasticsearch/fluentd:v2.5.2&#34;</span><span class=p>,</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;fluentd-elasticsearch&#34;</span><span class=p>,</span><span class=s2>&#34;resources&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;limits&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;memory&#34;</span><span class=o>:</span><span class=s2>&#34;200Mi&#34;</span><span class=p>},</span><span class=s2>&#34;requests&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;cpu&#34;</span><span class=o>:</span><span class=s2>&#34;100m&#34;</span><span class=p>,</span><span class=s2>&#34;memory&#34;</span><span class=o>:</span><span class=s2>&#34;200Mi&#34;</span><span class=p>}},</span><span class=s2>&#34;volumeMounts&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;mountPath&#34;</span><span class=o>:</span><span class=s2>&#34;/var/log&#34;</span><span class=p>,</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;varlog&#34;</span><span class=p>},{</span><span class=s2>&#34;mountPath&#34;</span><span class=o>:</span><span class=s2>&#34;/var/lib/docker/containers&#34;</span><span class=p>,</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;varlibdockercontainers&#34;</span><span class=p>,</span><span class=s2>&#34;readOnly&#34;</span><span class=o>:</span><span class=kc>true</span><span class=p>}]}],</span><span class=s2>&#34;terminationGracePeriodSeconds&#34;</span><span class=o>:</span><span class=mi>30</span><span class=p>,</span><span class=s2>&#34;tolerations&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;effect&#34;</span><span class=o>:</span><span class=s2>&#34;NoSchedule&#34;</span><span class=p>,</span><span class=s2>&#34;key&#34;</span><span class=o>:</span><span class=s2>&#34;node-role.kubernetes.io/master&#34;</span><span class=p>}],</span><span class=s2>&#34;volumes&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;hostPath&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;path&#34;</span><span class=o>:</span><span class=s2>&#34;/var/log&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;varlog&#34;</span><span class=p>},{</span><span class=s2>&#34;hostPath&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;path&#34;</span><span class=o>:</span><span class=s2>&#34;/var/lib/docker/containers&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;varlibdockercontainers&#34;</span><span class=p>}]}}}}</span>
  <span class=nx>creationTimestamp</span><span class=o>:</span> <span class=s2>&#34;2019-10-30T15:19:20Z&#34;</span>
  <span class=nx>generation</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>k8s</span><span class=o>-</span><span class=nx>app</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>logging</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>
  <span class=nx>resourceVersion</span><span class=o>:</span> <span class=s2>&#34;6046222&#34;</span>
  <span class=nx>selfLink</span><span class=o>:</span> <span class=err>/apis/extensions/v1beta1/namespaces/kube-system/daemonsets/fluentd-elasticsearch</span>
  <span class=nx>uid</span><span class=o>:</span> <span class=nx>c2c02c48</span><span class=o>-</span><span class=mi>9</span><span class=nx>f93</span><span class=o>-</span><span class=mi>48</span><span class=nx>f3</span><span class=o>-</span><span class=mi>9</span><span class=nx>d6c</span><span class=o>-</span><span class=mi>32</span><span class=nx>bfa671db0e</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>revisionHistoryLimit</span><span class=o>:</span> <span class=mi>10</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>creationTimestamp</span><span class=o>:</span> <span class=kc>null</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>image</span><span class=o>:</span> <span class=nx>quay</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>fluentd_elasticsearch</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>:</span><span class=nx>v2</span><span class=mf>.5.2</span>
        <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
        <span class=nx>resources</span><span class=o>:</span>
          <span class=nx>limits</span><span class=o>:</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>200</span><span class=nx>Mi</span>
          <span class=nx>requests</span><span class=o>:</span>
            <span class=nx>cpu</span><span class=o>:</span> <span class=mi>100</span><span class=nx>m</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>200</span><span class=nx>Mi</span>
        <span class=nx>terminationMessagePath</span><span class=o>:</span> <span class=err>/dev/termination-log</span>
        <span class=nx>terminationMessagePolicy</span><span class=o>:</span> <span class=nx>File</span>
        <span class=nx>volumeMounts</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>mountPath</span><span class=o>:</span> <span class=err>/var/log</span>
          <span class=nx>name</span><span class=o>:</span> <span class=nx>varlog</span>
        <span class=o>-</span> <span class=nx>mountPath</span><span class=o>:</span> <span class=err>/var/lib/docker/containers</span>
          <span class=nx>name</span><span class=o>:</span> <span class=nx>varlibdockercontainers</span>
          <span class=nx>readOnly</span><span class=o>:</span> <span class=kc>true</span>
      <span class=nx>dnsPolicy</span><span class=o>:</span> <span class=nx>ClusterFirst</span>
      <span class=nx>restartPolicy</span><span class=o>:</span> <span class=nx>Always</span>             <span class=err>#</span><span class=nx>重启策略必须为Always</span><span class=err>，</span><span class=nx>保障异常时能自动恢复</span>
      <span class=nx>schedulerName</span><span class=o>:</span> <span class=k>default</span><span class=o>-</span><span class=nx>scheduler</span>  <span class=err>#</span><span class=nx>默认调度策略</span>
      <span class=nx>securityContext</span><span class=o>:</span> <span class=p>{}</span>
      <span class=nx>terminationGracePeriodSeconds</span><span class=o>:</span> <span class=mi>30</span>
      <span class=nx>tolerations</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>effect</span><span class=o>:</span> <span class=nx>NoSchedule</span>
        <span class=nx>key</span><span class=o>:</span> <span class=nx>node</span><span class=o>-</span><span class=nx>role</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>master</span>
      <span class=nx>volumes</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>hostPath</span><span class=o>:</span>
          <span class=nx>path</span><span class=o>:</span> <span class=err>/var/log</span>
          <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;&#34;</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>varlog</span>
      <span class=o>-</span> <span class=nx>hostPath</span><span class=o>:</span>
          <span class=nx>path</span><span class=o>:</span> <span class=err>/var/lib/docker/containers</span>
          <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;&#34;</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>varlibdockercontainers</span>
  <span class=nx>templateGeneration</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>updateStrategy</span><span class=o>:</span>  <span class=err>#</span><span class=nx>滚动更新策略</span>
    <span class=nx>rollingUpdate</span><span class=o>:</span>
      <span class=nx>maxUnavailable</span><span class=o>:</span> <span class=mi>1</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>RollingUpdate</span>
<span class=nx>status</span><span class=o>:</span>
  <span class=nx>currentNumberScheduled</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>desiredNumberScheduled</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>numberAvailable</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>numberMisscheduled</span><span class=o>:</span> <span class=mi>0</span>
  <span class=nx>numberReady</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>observedGeneration</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>updatedNumberScheduled</span><span class=o>:</span> <span class=mi>3</span>
</code></pre></td></tr></table></div></div><h2 id=13-滚动更新与回滚>1.3 滚动更新与回滚</h2><p>\1. 更新镜像至最新版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>daemonsets</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span><span class=o>=</span><span class=nx>quay</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>fluentd_elasticsearch</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>:</span><span class=nx>latest</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>
<span class=nx>daemonset</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> <span class=nx>image</span> <span class=nx>updated</span>
</code></pre></td></tr></table></div></div><p>\2. 查看滚动更新状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>status</span> <span class=nx>daemonset</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> 
<span class=nx>Waiting</span> <span class=k>for</span> <span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>rollout</span> <span class=nx>to</span> <span class=nx>finish</span><span class=o>:</span> <span class=mi>1</span> <span class=nx>out</span> <span class=k>of</span> <span class=mi>3</span> <span class=k>new</span> <span class=nx>pods</span> <span class=nx>have</span> <span class=nx>been</span> <span class=nx>updated</span><span class=p>...</span>
<span class=nx>Waiting</span> <span class=k>for</span> <span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>rollout</span> <span class=nx>to</span> <span class=nx>finish</span><span class=o>:</span> <span class=mi>1</span> <span class=nx>out</span> <span class=k>of</span> <span class=mi>3</span> <span class=k>new</span> <span class=nx>pods</span> <span class=nx>have</span> <span class=nx>been</span> <span class=nx>updated</span><span class=p>...</span>
<span class=nx>Waiting</span> <span class=k>for</span> <span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>rollout</span> <span class=nx>to</span> <span class=nx>finish</span><span class=o>:</span> <span class=mi>1</span> <span class=nx>out</span> <span class=k>of</span> <span class=mi>3</span> <span class=k>new</span> <span class=nx>pods</span> <span class=nx>have</span> <span class=nx>been</span> <span class=nx>updated</span><span class=p>...</span>
<span class=nx>Waiting</span> <span class=k>for</span> <span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>rollout</span> <span class=nx>to</span> <span class=nx>finish</span><span class=o>:</span> <span class=mi>2</span> <span class=nx>out</span> <span class=k>of</span> <span class=mi>3</span> <span class=k>new</span> <span class=nx>pods</span> <span class=nx>have</span> <span class=nx>been</span> <span class=nx>updated</span><span class=p>...</span>
<span class=nx>Waiting</span> <span class=k>for</span> <span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>rollout</span> <span class=nx>to</span> <span class=nx>finish</span><span class=o>:</span> <span class=mi>2</span> <span class=nx>out</span> <span class=k>of</span> <span class=mi>3</span> <span class=k>new</span> <span class=nx>pods</span> <span class=nx>have</span> <span class=nx>been</span> <span class=nx>updated</span><span class=p>...</span>
<span class=nx>Waiting</span> <span class=k>for</span> <span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>rollout</span> <span class=nx>to</span> <span class=nx>finish</span><span class=o>:</span> <span class=mi>2</span> <span class=nx>out</span> <span class=k>of</span> <span class=mi>3</span> <span class=k>new</span> <span class=nx>pods</span> <span class=nx>have</span> <span class=nx>been</span> <span class=nx>updated</span><span class=p>...</span>
<span class=nx>Waiting</span> <span class=k>for</span> <span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>rollout</span> <span class=nx>to</span> <span class=nx>finish</span><span class=o>:</span> <span class=mi>2</span> <span class=k>of</span> <span class=mi>3</span> <span class=nx>updated</span> <span class=nx>pods</span> <span class=nx>are</span> <span class=nx>available</span><span class=p>...</span>
<span class=nx>daemon</span> <span class=nx>set</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>successfully</span> <span class=nx>rolled</span> <span class=nx>out</span>
</code></pre></td></tr></table></div></div><p>\3. 查看DaemonSet详情，可以看到DS滚动更新的过程：DaemonSet先将node上的pod删除然后再创建</p><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E8%AF%A6%E8%A7%A3DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8/3%20-%201620.jpg alt=DaemonSet滚动更新过程></p><p>\4. 查看DaemonSet滚动更新版本，REVSION 1为初始的版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>history</span> <span class=nx>daemonset</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> 
<span class=nx>daemonset</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> 
<span class=nx>REVISION</span>  <span class=nx>CHANGE</span><span class=o>-</span><span class=nx>CAUSE</span>
<span class=mi>1</span>         <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=mi>2</span>         <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>\5. 更新回退，如果配置没有符合到预期可以回滚到原始的版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>undo</span> <span class=nx>daemonset</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> <span class=o>--</span><span class=nx>to</span><span class=o>-</span><span class=nx>revision</span><span class=o>=</span><span class=mi>1</span>
<span class=nx>daemonset</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> <span class=nx>rolled</span> <span class=nx>back</span>
</code></pre></td></tr></table></div></div><p>\6. 确认版本回退情况</p><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E8%AF%A6%E8%A7%A3DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8/4%20-%201620.jpg alt=DaemonSet版本回退></p><p>\7. 观察版本回退的过程，回退的过程和和滚动更新过程类似，先删除Pod再创建</p><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E8%AF%A6%E8%A7%A3DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8/5%20-%201620.jpg alt=DaemonSet回退过程></p><p>\8. 删除DaemonSet</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=k>delete</span> <span class=nx>daemonsets</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> 
<span class=nx>daemonset</span><span class=p>.</span><span class=nx>extensions</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>deleted</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=o>|</span><span class=nx>grep</span> <span class=nx>fluentd</span>
<span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span><span class=o>-</span><span class=nx>d6f6f</span>      <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>   <span class=mi>0</span>          <span class=mi>110</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><h2 id=14-daemonset调度>1.4 DaemonSet调度</h2><p>前面<a href=#>kubernetes系列教程（七）深入玩转pod调度</a>文章介绍了Pod的调度机制，DaemonSet通过kubernetes默认的调度器scheduler会在所有的node节点上运行一个Pod副本，可以通过如下三种方式将Pod运行在部分节点上：</p><ul><li>指定nodeName节点运行</li><li>通过标签运行nodeSelector</li><li>通过亲和力调度node Affinity和node Anti-affinity</li></ul><p>DaemonSet调度算法用于实现将Pod运行在特定的node节点上，如下以通过node affinity亲和力将Pod调度到部分的节点上node-2上为例。</p><p>\1. 为node添加一个app=web的labels</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>nodes</span> <span class=o>--</span><span class=nx>show</span><span class=o>-</span><span class=nx>labels</span> 
<span class=nx>NAME</span>     <span class=nx>STATUS</span>   <span class=nx>ROLES</span>    <span class=nx>AGE</span>   <span class=nx>VERSION</span>   <span class=nx>LABELS</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>1</span>   <span class=nx>Ready</span>    <span class=nx>master</span>   <span class=mi>47</span><span class=nx>d</span>   <span class=nx>v1</span><span class=mf>.15.3</span>   <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span><span class=o>=</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>node</span><span class=o>-</span><span class=nx>role</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>master</span><span class=o>=</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=nx>Ready</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>   <span class=mi>47</span><span class=nx>d</span>   <span class=nx>v1</span><span class=mf>.15.3</span>   <span class=nx>app</span><span class=o>=</span><span class=nx>web</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span><span class=o>=</span><span class=nx>node</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=nx>Ready</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>   <span class=mi>47</span><span class=nx>d</span>   <span class=nx>v1</span><span class=mf>.15.3</span>   <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span><span class=o>=</span><span class=nx>node</span><span class=o>-</span><span class=mi>3</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span>
</code></pre></td></tr></table></div></div><p>\2. 添加node affinity亲和力调度算法，requiredDuringSchedulingIgnoredDuringExecution设置基本需要满足条件，preferredDuringSchedulingIgnoredDuringExecution设置优选满足条件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>es</span><span class=o>-</span><span class=nx>daemonset</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>DaemonSet</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>k8s</span><span class=o>-</span><span class=nx>app</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>logging</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>tolerations</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>key</span><span class=o>:</span> <span class=nx>node</span><span class=o>-</span><span class=nx>role</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>master</span>
        <span class=nx>effect</span><span class=o>:</span> <span class=nx>NoSchedule</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>quay</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>fluentd_elasticsearch</span><span class=o>/</span><span class=nx>fluentd</span><span class=o>:</span><span class=nx>v2</span><span class=mf>.5.2</span>
        <span class=nx>resources</span><span class=o>:</span>
          <span class=nx>limits</span><span class=o>:</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>200</span><span class=nx>Mi</span>
          <span class=nx>requests</span><span class=o>:</span>
            <span class=nx>cpu</span><span class=o>:</span> <span class=mi>100</span><span class=nx>m</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>200</span><span class=nx>Mi</span>
        <span class=nx>volumeMounts</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlog</span>
          <span class=nx>mountPath</span><span class=o>:</span> <span class=err>/var/log</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlibdockercontainers</span>
          <span class=nx>mountPath</span><span class=o>:</span> <span class=err>/var/lib/docker/containers</span>
          <span class=nx>readOnly</span><span class=o>:</span> <span class=kc>true</span>
      <span class=nx>affinity</span><span class=o>:</span>
        <span class=nx>nodeAffinity</span><span class=o>:</span>
          <span class=nx>preferredDuringSchedulingIgnoredDuringExecution</span><span class=o>:</span>  <span class=err>#</span><span class=nx>优先满足条件</span>
          <span class=o>-</span> <span class=nx>weight</span><span class=o>:</span> <span class=mi>1</span>
            <span class=nx>preference</span><span class=o>:</span>
              <span class=nx>matchExpressions</span><span class=o>:</span>
              <span class=o>-</span> <span class=nx>key</span><span class=o>:</span> <span class=nx>app</span> 
                <span class=nx>operator</span><span class=o>:</span> <span class=nx>In</span>
                <span class=nx>values</span><span class=o>:</span>
                <span class=o>-</span> <span class=nx>web</span> 
          <span class=nx>requiredDuringSchedulingIgnoredDuringExecution</span><span class=o>:</span>  <span class=err>#</span><span class=nx>要求满足条件</span>
            <span class=nx>nodeSelectorTerms</span><span class=o>:</span>
            <span class=o>-</span> <span class=nx>matchExpressions</span><span class=o>:</span>
              <span class=o>-</span> <span class=nx>key</span><span class=o>:</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span>
                <span class=nx>operator</span><span class=o>:</span> <span class=nx>In</span>
                <span class=nx>values</span><span class=o>:</span>
                <span class=o>-</span> <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>
                <span class=o>-</span> <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>
      <span class=nx>terminationGracePeriodSeconds</span><span class=o>:</span> <span class=mi>30</span>
      <span class=nx>volumes</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlog</span>
        <span class=nx>hostPath</span><span class=o>:</span>
          <span class=nx>path</span><span class=o>:</span> <span class=err>/var/log</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>varlibdockercontainers</span>
        <span class=nx>hostPath</span><span class=o>:</span>
          <span class=nx>path</span><span class=o>:</span> <span class=err>/var/lib/docker/containers</span>
</code></pre></td></tr></table></div></div><p>\3. 生成DS，并查看列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=k>delete</span> <span class=nx>ds</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> 
<span class=nx>daemonset</span><span class=p>.</span><span class=nx>extensions</span> <span class=s2>&#34;fluentd-elasticsearch&#34;</span> <span class=nx>deleted</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>daemonsets</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span> 
<span class=nx>NAME</span>                    <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>NODE</span> <span class=nx>SELECTOR</span>   <span class=nx>AGE</span>
<span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span>   <span class=mi>1</span>         <span class=mi>1</span>         <span class=mi>1</span>       <span class=mi>1</span>            <span class=mi>1</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>          <span class=mi>112</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>\4. 校验Pod运行的情况，DaemonSet的Pod调度到node-2节点上</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> 
<span class=nx>NAME</span>                             <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>     <span class=nx>IP</span>               <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>          <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>fluentd</span><span class=o>-</span><span class=nx>elasticsearch</span><span class=o>-</span><span class=mi>9</span><span class=nx>kngs</span>      <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>2</span><span class=nx>m39s</span>   <span class=mf>10.244.1.82</span>      <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><h1 id=写在最后><strong>写在最后</strong></h1><p>本文介绍了kubernetes中DaemonSet控制器，DS控制器能确保所有的节点运行一个特定的daemon守护进程，此外通过nodeSelector或node Affinity能够实现将Pod调度到特定的node节点。</p><h1 id=参考文档><strong>参考文档</strong></h1><p>DaemonSet**：**<a href=https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/>https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</a></p><blockquote><p>『 转载 』该文章来源于网络，侵删。</p></blockquote></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content><a href=https://agou-ops.top/author/agou-ops/>AGou-ops</a></span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2019-08-04</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ rel=noopener target=_blank>CC BY-NC-ND 4.0</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>Reward Me?</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/wechat.png>
<span>Wechat</span></label>
<label class=qr-code-image for=reward><img class=image src=https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/alipay.png>
<span>Alipay</span></label></div></div><footer class=post-footer><div class=post-tags><a href=https://agou-ops.top/tags/kubernetes/>kubernetes</a></div><nav class=post-nav><a class=prev href=/post/k8s/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg></i><span class="prev-text nav-default">11 深入学习Deployment控制器</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/k8s/13-%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BB%BB%E5%8A%A1job%E5%92%8C%E5%91%A8%E6%9C%9F%E4%BB%BB%E5%8A%A1/><span class="next-text nav-default">13 一次性任务Job和周期任务</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"/></svg></i></a></nav></footer></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=AGou-ops/comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:agou-ops@foxmail.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408 1361.641813S1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523L83.726336 1024H682.532949 753.579947 1348.948139L1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955C777.248 802.205449 742.347691 811.03081 718.063616 811.603883z"/></svg></a><a href=https://www.youtube.com/channel/UCkLgMBY9hnLegjLTulM1guw rel="me noopener" class=iconfont title=youtube target=_blank><svg fill="#000" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="36" height="36"><path fill-rule="evenodd" d="M13 5l3 9v6h2V14l3-9H19l-2 6-2-6zM24 9C22.933594 9 22.410156 9.167969 21.757813 9.703125 21.132813 10.230469 20.960938 10.636719 21 12v5C21 17.996094 21.164063 18.652344 21.765625 19.234375 22.390625 19.816406 22.980469 20 24 20 25.066406 20 25.648438 19.816406 26.25 19.234375 26.875 18.675781 27 17.996094 27 17V12C27 11.117188 26.84375 10.28125 26.238281 9.722656 25.613281 9.148438 24.96875 9 24 9zm5 0v9C29 18.972656 29.980469 20 31 20S32.558594 19.488281 33 19v1h2V9H33v8C32.988281 17.683594 32.183594 18 32 18 31.792969 18 31 17.957031 31 17V9zm-5 2C24.300781 11 25 10.996094 25 12v5C25 17.96875 24.324219 18 24 18 23.699219 18 23 17.988281 23 17V12C23 11.183594 23.433594 11 24 11zM10 22C6.40625 22 4 24.382813 4 28v9.5C4 41.117188 6.40625 44 10 44H40C43.59375 44 46 41.617188 46 38V28C46 24.382813 43.59375 22 40 22zm2 4h6v2H16V40H14V28H12zm14 0h2v4C28.230469 29.640625 28.574219 29.355469 28.902344 29.195313 29.222656 29.03125 29.546875 28.9375 29.875 28.9375 30.523438 28.9375 31.03125 29.171875 31.378906 29.609375 31.726563 30.050781 32 30.636719 32 31.5v6C32 38.242188 31.75 38.703125 31.421875 39.097656 31.101563 39.492188 30.621094 39.992188 30 40 28.949219 40.011719 28.386719 39.449219 28 39v1H26zm-8 3h2v8C20 37.230469 20.269531 38.007813 21 38 21.8125 37.992188 21.820313 37.234375 22 37V29h2V40H22V39C21.628906 39.4375 21.4375 39.574219 21.019531 39.78125 20.605469 40.015625 20.183594 40 19.792969 40 19.308594 40 18.757813 39.5625 18.5 39.234375 18.269531 38.933594 18 38.625 18 38zm18.199219.0C37.148438 29 37.816406 29.203125 38.320313 29.734375 38.835938 30.265625 39 30.886719 39 31.886719V35H35v1.546875C35 37.105469 35.074219 37.460938 35.21875 37.671875 35.355469 37.902344 35.632813 38.003906 36 38 36.40625 37.996094 36.664063 37.914063 36.800781 37.730469 36.941406 37.566406 37 37.101563 37 36.5V36h2v.59375C39 37.683594 38.914063 38.496094 38.375 39.027344 37.867188 39.585938 37.074219 39.84375 36.035156 39.84375 35.085938 39.84375 34.34375 39.5625 33.8125 38.984375S33.003906 37.613281 33.003906 36.59375V31.886719C33.003906 30.980469 33.320313 30.308594 33.902344 29.710938 34.371094 29.230469 35.25 29 36.199219 29zM29 30.5C28.449219 30.5 28.007813 30.996094 28 31.5v6C28.007813 37.789063 28.449219 38 29 38S30 37.574219 30 37.023438V32C30 31 29.550781 30.5 29 30.5zm7 .5C35.449219 31 35.007813 31.464844 35 32v1h2V32C37 31.386719 36.550781 31 36 31z"/></svg></a><a href=https://twitter.com/AgouOps rel="me noopener" class=iconfont title=twitter target=_blank><svg class="icon" viewBox="0 0 1264 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M1229.8616 18.043658s-117.852626 63.135335-164.151872 67.344358c-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"/></svg></a><a href=https://github.com/AGou-ops rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=https://agou-ops.top/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=copyright-year>&copy;
2018 -
2020
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author>AGou-ops</span></span>
<span class=power-by><a title="Host on GitHub & AliOSS"><font size=2>Host on</font> <font size=2 color=red>GitHub & AliOSS</font></a></span>
<span class=division>|</span>
<span class=theme-info><a title="Provided by Algolia & utteranc"><font size=2>Providers -</font> <font size=2 color=red>Algolia & utteranc</font></a></span></br><span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span></span>
<span><a class=theme-link href=http://beian.miit.gov.cn/>鲁ICP备19050296号-2</a></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js crossorigin=anonymous></script><script type=text/javascript src=https://cdn.bootcss.com/slideout/1.0.1/slideout.min.js crossorigin=anonymous></script><script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script><script id=baidu_push>(function(){if(window.location.hostname==='localhost')return;var bp=document.createElement('script');bp.async=true;var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script src=/js/load-photoswipe.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin=anonymous></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:"6a2c773473e3d77a8e761f3f64825c5a",indexName:"main-blog",appId:"5M8VQRD7W9",inputSelector:'.docsearch-input',debug:false,});</script><script src=/js/custom.js></script><script src=/js/clipboard.min.js></script></body></html>