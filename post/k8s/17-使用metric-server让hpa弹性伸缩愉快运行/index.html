<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>17 使用metric Server让HPA弹性伸缩愉快运行 - AGou's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="AGou-ops"><meta name=description content="1. 监控架构概述 kubernetes监控指标大体可以分为两类：核心监控指标和自定义指标，核心监控指标是kubernetes内置稳定可靠监控指标"><meta name=keywords content="AGou,AGou-ops,阿狗,阿狗博客,阿狗的博客,AGou blog"><meta name=baidu-site-verification content="eS8otJ2dE7My4oKT"><meta name=generator content="Hugo 0.75.1"><link rel=canonical href=https://agou-ops.cn/post/k8s/17-%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9hpa%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/><link rel=icon type=image/x-ico href=https://s1.ax1x.com/2020/05/19/Y4cixe.png><link rel=stylesheet href=/sass/jane.min.5f2fe3fb513889592785b1bd02ae09514f6c36ea67c4f178b1424eafc16d4b93.css integrity media=screen crossorigin=anonymous><link rel=stylesheet href=/css/layer.css><meta property="og:title" content="17 使用metric Server让HPA弹性伸缩愉快运行"><meta property="og:description" content="1. 监控架构概述 kubernetes监控指标大体可以分为两类：核心监控指标和自定义指标，核心监控指标是kubernetes内置稳定可靠监控指标"><meta property="og:type" content="article"><meta property="og:url" content="https://agou-ops.cn/post/k8s/17-%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9hpa%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/"><meta property="article:published_time" content="2019-08-04T10:36:48+08:00"><meta property="article:modified_time" content="2019-08-04T10:36:48+08:00"><meta itemprop=name content="17 使用metric Server让HPA弹性伸缩愉快运行"><meta itemprop=description content="1. 监控架构概述 kubernetes监控指标大体可以分为两类：核心监控指标和自定义指标，核心监控指标是kubernetes内置稳定可靠监控指标"><meta itemprop=datePublished content="2019-08-04T10:36:48+08:00"><meta itemprop=dateModified content="2019-08-04T10:36:48+08:00"><meta itemprop=wordCount content="5403"><meta itemprop=keywords content="kubernetes,"><meta name=twitter:card content="summary"><meta name=twitter:title content="17 使用metric Server让HPA弹性伸缩愉快运行"><meta name=twitter:description content="1. 监控架构概述 kubernetes监控指标大体可以分为两类：核心监控指标和自定义指标，核心监控指标是kubernetes内置稳定可靠监控指标"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script async src="https://www.googletagmanager.com/gtag/js?id=G-2DZCW6NJZF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-2DZCW6NJZF');</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>AGou's blog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.cn/>主页</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.cn/post/>归档</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.cn/tags/>标签</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.cn/aboutme/>关于</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.cn/anime/>💞Anime</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://agou-ops.cn/myDocsv2 rel=noopener target=_blank>myDocs
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408 512.128C896 481.792 871.424 457.152 841.152 457.152z"/></svg></i></a></li><input size=15 maxlength=15 type=search class=docsearch placeholder="Search Here..."></ul></nav><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css integrity="sha256-LWdHSKWG7zv3DTpee8YAgoTfkj3gNkfauF624h4P2Nw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css integrity="sha256-Q9bBMw/rHRRag46GDWY84J3elDNc8JJjKXL9tIC4oe8=" crossorigin=anonymous><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><style>.fork-me-on-github{position:absolute;top:0;right:0;border:0}@media(max-width:1080px){.fork-me-on-github{display:none}}</style><a href=https://github.com/AGou-ops><img loading=lazy width=149 height=149 class=fork-me-on-github src=https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/forkme_right_gray_6d6d6d.svg data-recalc-dims=1 alt="Fork me on GitHub"></a><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>AGou's blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://agou-ops.cn/>主页</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.cn/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.cn/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.cn/aboutme/>关于</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.cn/anime/>💞Anime</a></li><li class=menu-item><a class=menu-item-link href=https://agou-ops.cn/myDocsv2 rel=noopener target=_blank>myDocs
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408 512.128C896 481.792 871.424 457.152 841.152 457.152z"/></svg></i></a></li><input size=15 maxlength=15 type=search class=docsearch-input placeholder="Search Here..."></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>17 使用metric Server让HPA弹性伸缩愉快运行</h1><div class=post-meta><time datetime=2019-08-04 class=post-time>2019-08-04</time><div class=post-category><a href=https://agou-ops.cn/categories/%E8%BD%AC%E8%BD%BD/>转载</a>
<a href=https://agou-ops.cn/categories/kubernetes/>kubernetes</a>
<a href=https://agou-ops.cn/categories/%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/>基础教程</a></div><span class=more-meta>5403 words</span>
<span class=more-meta>11 min read</span>
<span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Table of Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#2-1-metric-server简介>2. 1 metric-server简介</a></li><li><a href=#22-metric-server架构>2.2 metric-server架构</a></li><li><a href=#23-metric-server部署>2.3 metric-server部署</a></li><li><a href=#24-metric-server-api测试>2.4 metric-server api测试</a></li></ul><ul><li><a href=#31-hpa概述>3.1 HPA概述</a></li><li><a href=#32-hpa实现>3.2 HPA实现</a></li></ul></nav></div></div><div class=post-content><h1 id=1-监控架构概述>1. 监控架构概述</h1><p>kubernetes监控指标大体可以分为两类：核心监控指标和自定义指标，核心监控指标是kubernetes内置稳定可靠监控指标，早期由heapster完成，现由metric-server实现；自定义指标用于实现核心指标的扩展，能够提供更丰富的指标支持，如应用状态指标，自定义指标需要通过Aggregator和k8s api集成，当前主流通过promethues实现。</p><p>监控指标用途：</p><ul><li>kubectl top 查看node和pod的cpu+内存使用情况</li><li>kubernetes-dashbaord 控制台查看节点和pod资源监控</li><li>Horizontal Pod Autoscaler 水平横向动态扩展</li><li>Scheduler 调度器调度选择条件</li></ul><h1 id=2-metric-server架构和安装>2. metric-server架构和安装</h1><h2 id=2-1-metric-server简介>2. 1 metric-server简介</h2><blockquote><p>Metrics Server is a cluster-wide aggregator of resource usage data. Resource metrics are used by components like kubectl top and the Horizontal Pod Autoscaler to scale workloads. To autoscale based upon a custom metric, you need to use the Prometheus Adapter Metric-server是一个集群级别的资源指标收集器，用于收集资源指标数据</p></blockquote><ul><li>提供基础资源如CPU、内存监控接口查询；</li><li>接口通过 Kubernetes aggregator注册到kube-apiserver中；</li><li>对外通过Metric API暴露给外部访问；</li><li>自定义指标使用需要借助Prometheus实现。</li></ul><p>The Metrics API</p><ul><li>/node 获取所有节点的指标，指标名称为NodeMetrics</li><li>/node/&lt;node_name> 特定节点指标</li><li>/namespaces/{namespace}/pods 获取命名空间下的所有pod指标</li><li>/namespaces/{namespace}/pods/{pod} 特定pod的指标，指标名称为PodMetrics</li></ul><p>未来将能够支持指标聚合，如max最大值，min最小值，95th峰值，以及自定义时间窗口，如1h，1d，1w等。</p><h2 id=22-metric-server架构>2.2 metric-server架构</h2><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B9%9D)%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9HPA%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/1%20-%201620.jpg alt=monitoring_architecture.png></p><p>监控架构分两部分内容：核心监控(图白色部分)和自定义监控（图蓝色部分）</p><p>1、 核心监控实现</p><ul><li>通过kubelet收集资源估算+使用估算</li><li>metric-server负责数据收集，不负责数据存储</li><li>metric-server对外暴露Metric API接口</li><li>核心监控指标客用户HPA，kubectl top，scheduler和dashboard</li></ul><p>2、 自定义监控实现</p><ul><li>自定义监控指标包括监控指标和服务指标</li><li>需要在每个node上部署一个agent上报至集群监控agent，如prometheus</li><li>集群监控agent收集数据后需要将监控指标+服务指标通过API adaptor转换为apiserver能够处理的接口</li><li>HPA通过自定义指标实现更丰富的弹性扩展能力，需要通过HPA adaptor API做次转换。</li></ul><h2 id=23-metric-server部署>2.3 metric-server部署</h2><p>1、获取metric-server安装文件，当前具有两个版本：1.7和1.8+，kubernetes1.7版本安装1.7的metric-server版本，kubernetes 1.8后版本安装metric server 1.8+版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>git</span> <span class=nx>clone</span> <span class=nx>https</span><span class=o>:</span><span class=c1>//github.com/kubernetes-sigs/metrics-server.git
</span></code></pre></td></tr></table></div></div><p>2、部署metric-server，部署1.8+版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>deploy</span><span class=o>/</span><span class=mf>1.8</span><span class=o>+</span><span class=err>/</span>
<span class=nx>clusterrole</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>system</span><span class=o>:</span><span class=nx>aggregated</span><span class=o>-</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>reader</span> <span class=nx>created</span>
<span class=nx>clusterrolebinding</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=o>:</span><span class=nx>system</span><span class=o>:</span><span class=nx>auth</span><span class=o>-</span><span class=nx>delegator</span> <span class=nx>created</span>
<span class=nx>rolebinding</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=o>-</span><span class=nx>auth</span><span class=o>-</span><span class=nx>reader</span> <span class=nx>created</span>
<span class=nx>apiservice</span><span class=p>.</span><span class=nx>apiregistration</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>v1beta1</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span> <span class=nx>created</span>
<span class=nx>serviceaccount</span><span class=o>/</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span> <span class=nx>created</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>apps</span><span class=o>/</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span> <span class=nx>created</span>
<span class=nx>service</span><span class=o>/</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span> <span class=nx>created</span>
<span class=nx>clusterrole</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>system</span><span class=o>:</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span> <span class=nx>created</span>
<span class=nx>clusterrolebinding</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>system</span><span class=o>:</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span> <span class=nx>created</span>
</code></pre></td></tr></table></div></div><p>核心的配置文件是metrics-server-deployment.yaml，metric-server以Deployment的方式部署在集群中，j镜像k8s.gcr.io/metrics-server-amd64:v0.3.6需要提前下载好，其对应的安装文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=o>---</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>ServiceAccount</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>
<span class=o>---</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Deployment</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>k8s</span><span class=o>-</span><span class=nx>app</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>k8s</span><span class=o>-</span><span class=nx>app</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>name</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>k8s</span><span class=o>-</span><span class=nx>app</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>serviceAccountName</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
      <span class=nx>volumes</span><span class=o>:</span>
      <span class=err>#</span> <span class=nx>mount</span> <span class=k>in</span> <span class=nx>tmp</span> <span class=nx>so</span> <span class=nx>we</span> <span class=nx>can</span> <span class=nx>safely</span> <span class=nx>use</span> <span class=nx>from</span><span class=o>-</span><span class=nx>scratch</span> <span class=nx>images</span> <span class=nx>and</span><span class=o>/</span><span class=nx>or</span> <span class=nx>read</span><span class=o>-</span><span class=nx>only</span> <span class=nx>containers</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>tmp</span><span class=o>-</span><span class=nx>dir</span>
        <span class=nx>emptyDir</span><span class=o>:</span> <span class=p>{}</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>gcr</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=o>-</span><span class=nx>amd64</span><span class=o>:</span><span class=nx>v0</span><span class=mf>.3.6</span>
        <span class=nx>args</span><span class=o>:</span>
          <span class=o>-</span> <span class=o>--</span><span class=nx>cert</span><span class=o>-</span><span class=nx>dir</span><span class=o>=</span><span class=err>/tmp</span>
          <span class=o>-</span> <span class=o>--</span><span class=nx>secure</span><span class=o>-</span><span class=nx>port</span><span class=o>=</span><span class=mi>4443</span>
<span class=nx>ExternalIP</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>main</span><span class=o>-</span><span class=nx>port</span>
          <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>4443</span>
          <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
        <span class=nx>securityContext</span><span class=o>:</span>
          <span class=nx>readOnlyRootFilesystem</span><span class=o>:</span> <span class=kc>true</span>
          <span class=nx>runAsNonRoot</span><span class=o>:</span> <span class=kc>true</span>
          <span class=nx>runAsUser</span><span class=o>:</span> <span class=mi>1000</span>
        <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>Always</span>
        <span class=nx>volumeMounts</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>tmp</span><span class=o>-</span><span class=nx>dir</span>
          <span class=nx>mountPath</span><span class=o>:</span> <span class=err>/tmp</span>
      <span class=nx>nodeSelector</span><span class=o>:</span>
        <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>:</span> <span class=nx>linux</span>
</code></pre></td></tr></table></div></div><p>3、检查metric-server部署的情况,查看metric-server的Pod已部署成功</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=mf>1.8</span><span class=o>+</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> 
<span class=nx>NAME</span>             <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=mi>1</span>            <span class=mi>1</span>           <span class=mi>2</span><span class=nx>m49s</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=mf>1.8</span><span class=o>+</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=o>-</span><span class=mi>67</span><span class=nx>db467b7b</span><span class=o>-</span><span class=mi>5</span><span class=nx>xf8x</span> 
<span class=nx>NAME</span>                              <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=o>-</span><span class=mi>67</span><span class=nx>db467b7b</span><span class=o>-</span><span class=mi>5</span><span class=nx>xf8x</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>3</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>实际此时metric-server并不能使用，使用kubectl top node <node-id>查看会提示Error from server (NotFound): nodemetrics.metrics.k8s.io &ldquo;node-1&rdquo; not found类似的报错，查看metric-server的pod的日志信息，显示如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=mf>1.8</span><span class=o>+</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>logs</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=o>-</span><span class=mi>67</span><span class=nx>db467b7b</span><span class=o>-</span><span class=mi>5</span><span class=nx>xf8x</span>  <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=o>-</span><span class=nx>f</span>
<span class=nx>I1230</span> <span class=mi>11</span><span class=o>:</span><span class=mi>34</span><span class=o>:</span><span class=mf>10.905500</span>       <span class=mi>1</span> <span class=nx>serving</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>312</span><span class=p>]</span> <span class=nx>Generated</span> <span class=nx>self</span><span class=o>-</span><span class=nx>signed</span> <span class=nx>cert</span> <span class=p>(</span><span class=err>/tmp/apiserver.crt, /tmp/apiserver.key)</span>
<span class=nx>I1230</span> <span class=mi>11</span><span class=o>:</span><span class=mi>34</span><span class=o>:</span><span class=mf>11.527346</span>       <span class=mi>1</span> <span class=nx>secure_serving</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>116</span><span class=p>]</span> <span class=nx>Serving</span> <span class=nx>securely</span> <span class=nx>on</span> <span class=p>[</span><span class=o>::</span><span class=p>]</span><span class=o>:</span><span class=mi>4443</span>
<span class=nx>E1230</span> <span class=mi>11</span><span class=o>:</span><span class=mi>35</span><span class=o>:</span><span class=mf>11.552067</span>       <span class=mi>1</span> <span class=nx>manager</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>111</span><span class=p>]</span> <span class=nx>unable</span> <span class=nx>to</span> <span class=nx>fully</span> <span class=nx>collect</span> <span class=nx>metrics</span><span class=o>:</span> <span class=p>[</span><span class=nx>unable</span> <span class=nx>to</span> <span class=nx>fully</span> <span class=nx>scrape</span> <span class=nx>metrics</span> <span class=nx>from</span> <span class=nx>source</span> <span class=nx>kubelet_summary</span><span class=o>:</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span><span class=o>:</span> <span class=nx>unable</span> <span class=nx>to</span> <span class=nx>fetch</span> <span class=nx>metrics</span> <span class=nx>from</span> <span class=nx>Kubelet</span> <span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=p>(</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>:</span> <span class=nx>Get</span> <span class=nx>https</span><span class=o>:</span><span class=c1>//node-1:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup node-1 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:node-3: unable to fetch metrics from Kubelet node-3 (node-3): Get https://node-3:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup node-3 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:node-2: unable to fetch metrics from Kubelet node-2 (node-2): Get https://node-2:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup node-2 on 10.96.0.10:53: no such host]
</span></code></pre></td></tr></table></div></div><p>4、上述的报错信息提示pod中通过DNS无法解析主机名，可以通过在pod中定义hosts文件或告知metric-server优先使用IP的方式通讯，修改metric-server的deployment配置文件，修改如下并重新应用配置</p><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B9%9D)%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9HPA%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/2%20-%201620.jpg alt=修改metric-server部署配置文件></p><p>5、应用metric-server部署文件后重新生成一个pod，日志中再次查看提示另外一个报错信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=mf>1.8</span><span class=o>+</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>logs</span> <span class=nx>metrics</span><span class=o>-</span><span class=nx>server</span><span class=o>-</span><span class=nx>f54f5d6bf</span><span class=o>-</span><span class=nx>s42rc</span>   <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=o>-</span><span class=nx>f</span>
<span class=nx>I1230</span> <span class=mi>11</span><span class=o>:</span><span class=mi>45</span><span class=o>:</span><span class=mf>26.615547</span>       <span class=mi>1</span> <span class=nx>serving</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>312</span><span class=p>]</span> <span class=nx>Generated</span> <span class=nx>self</span><span class=o>-</span><span class=nx>signed</span> <span class=nx>cert</span> <span class=p>(</span><span class=err>/tmp/apiserver.crt, /tmp/apiserver.key)</span>
<span class=nx>I1230</span> <span class=mi>11</span><span class=o>:</span><span class=mi>45</span><span class=o>:</span><span class=mf>27.043723</span>       <span class=mi>1</span> <span class=nx>secure_serving</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>116</span><span class=p>]</span> <span class=nx>Serving</span> <span class=nx>securely</span> <span class=nx>on</span> <span class=p>[</span><span class=o>::</span><span class=p>]</span><span class=o>:</span><span class=mi>4443</span>

<span class=nx>E1230</span> <span class=mi>11</span><span class=o>:</span><span class=mi>46</span><span class=o>:</span><span class=mf>27.065274</span>       <span class=mi>1</span> <span class=nx>manager</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>111</span><span class=p>]</span> <span class=nx>unable</span> <span class=nx>to</span> <span class=nx>fully</span> <span class=nx>collect</span> <span class=nx>metrics</span><span class=o>:</span> <span class=p>[</span><span class=nx>unable</span> <span class=nx>to</span> <span class=nx>fully</span> <span class=nx>scrape</span> <span class=nx>metrics</span> <span class=nx>from</span> <span class=nx>source</span> <span class=nx>kubelet_summary</span><span class=o>:</span><span class=nx>node</span><span class=o>-</span><span class=mi>2</span><span class=o>:</span> <span class=nx>unable</span> <span class=nx>to</span> <span class=nx>fetch</span> <span class=nx>metrics</span> <span class=nx>from</span> <span class=nx>Kubelet</span> <span class=nx>node</span><span class=o>-</span><span class=mi>2</span> <span class=p>(</span><span class=mf>10.254.100.102</span><span class=p>)</span><span class=o>:</span> <span class=nx>Get</span> <span class=nx>https</span><span class=o>:</span><span class=c1>//10.254.100.102:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.254.100.102 because it doesn&#39;t contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:node-1: unable to fetch metrics from Kubelet node-1 (10.254.100.101): Get https://10.254.100.101:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.254.100.101 because it doesn&#39;t contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:node-3: unable to fetch metrics from Kubelet node-3 (10.254.100.103): Get https://10.254.100.103:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.254.100.103 because it doesn&#39;t contain any IP SANs]
</span></code></pre></td></tr></table></div></div><p>6、修改metric-server的deployments配置文件，添加&ndash;kubelet-insecure-tls参数设置</p><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B9%9D)%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9HPA%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/3%20-%201620.jpg alt=metric-server调整部署参数></p><p>再次重新部署后无报错，等待几分钟后就有数据上报告metric-server中了，可以通过kubectl top进行验证测试。</p><h2 id=24-metric-server-api测试>2.4 metric-server api测试</h2><p>1、安装完metric-server后会增加一个metrics.k8s.io/v1beta1的API组，该API组通过Aggregator接入apiserver中</p><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B9%9D)%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9HPA%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/4%20-%201620.jpg alt="metric-server api接口"></p><p>2、使用命令行查看kubectl top node的监控信息,可以看到CPU和内存的利用率</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=mf>1.8</span><span class=o>+</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>top</span> <span class=nx>node</span> 
<span class=nx>NAME</span>     <span class=nx>CPU</span><span class=p>(</span><span class=nx>cores</span><span class=p>)</span>   <span class=nx>CPU</span><span class=o>%</span>   <span class=nx>MEMORY</span><span class=p>(</span><span class=nx>bytes</span><span class=p>)</span>   <span class=nx>MEMORY</span><span class=o>%</span>   
<span class=nx>node</span><span class=o>-</span><span class=mi>1</span>   <span class=mi>110</span><span class=nx>m</span>         <span class=mi>5</span><span class=o>%</span>     <span class=mi>4127</span><span class=nx>Mi</span>          <span class=mi>53</span><span class=o>%</span>       
<span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=mi>53</span><span class=nx>m</span>          <span class=mi>5</span><span class=o>%</span>     <span class=mi>1066</span><span class=nx>Mi</span>          <span class=mi>61</span><span class=o>%</span>       
<span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=mi>34</span><span class=nx>m</span>          <span class=mi>3</span><span class=o>%</span>     <span class=mi>1002</span><span class=nx>Mi</span>          <span class=mi>57</span><span class=o>%</span>   
</code></pre></td></tr></table></div></div><p>3、查看pod监控信息,可以看到pod中CPU和内存的使用情况</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=mf>1.8</span><span class=o>+</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>top</span> <span class=nx>pods</span>
<span class=nx>NAME</span>                                   <span class=nx>CPU</span><span class=p>(</span><span class=nx>cores</span><span class=p>)</span>   <span class=nx>MEMORY</span><span class=p>(</span><span class=nx>bytes</span><span class=p>)</span>   
<span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span><span class=o>-</span><span class=mi>686</span><span class=nx>c67b997</span><span class=o>-</span><span class=nx>kw8pp</span>             <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>689</span><span class=nx>b4f897</span><span class=o>-</span><span class=mi>7</span><span class=nx>cwmf</span>              <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=mi>5</span><span class=nx>pgjt</span>   <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>pst2q</span>   <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>sr8tm</span>   <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=nx>d77bdf4df</span><span class=o>-</span><span class=mi>7</span><span class=nx>kwbj</span>           <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=nx>d77bdf4df</span><span class=o>-</span><span class=mi>7</span><span class=nx>x6jn</span>           <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=nx>d77bdf4df</span><span class=o>-</span><span class=nx>hr88b</span>           <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=nx>d77bdf4df</span><span class=o>-</span><span class=nx>wc22k</span>           <span class=mi>0</span><span class=nx>m</span>           <span class=mi>1</span><span class=nx>Mi</span>             
<span class=nx>service</span><span class=o>-</span><span class=mi>1</span><span class=o>-</span><span class=mi>7</span><span class=nx>b66bf758f</span><span class=o>-</span><span class=nx>xj9jh</span>             <span class=mi>0</span><span class=nx>m</span>           <span class=mi>2</span><span class=nx>Mi</span>             
<span class=nx>service</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>7</span><span class=nx>c7444684d</span><span class=o>-</span><span class=nx>w9cv9</span>             <span class=mi>1</span><span class=nx>m</span>           <span class=mi>3</span><span class=nx>Mi</span>   
</code></pre></td></tr></table></div></div><p>4、除了用命令行连接metricc-server获取监控资源，还可以通过API方式链接方式获取，可用API有</p><ul><li>http://127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/nodes</li><li>http://127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/nodes/<node-name></li><li>http://127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/pods</li><li>http://127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/namespace/<namespace-name>/pods/&lt;pod-name</li></ul><p>如下测试API接口的使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>a</span><span class=err>、</span><span class=nx>创建一个kube</span> <span class=nx>proxy代理</span><span class=err>，</span><span class=nx>用于链接apiserver</span><span class=err>，</span><span class=nx>默认将监听在127的8001端口</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>proxy</span> 
<span class=nx>Starting</span> <span class=nx>to</span> <span class=nx>serve</span> <span class=nx>on</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>8001</span>

<span class=nx>b</span><span class=err>、</span><span class=nx>查看node列表的监控数据</span><span class=err>，</span><span class=nx>可以获取到所有node的资源监控数据</span><span class=err>，</span><span class=nx>usage中包含cpu和memory</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/nodes 
</span><span class=c1></span>  <span class=o>%</span> <span class=nx>Total</span>    <span class=o>%</span> <span class=nx>Received</span> <span class=o>%</span> <span class=nx>Xferd</span>  <span class=nx>Average</span> <span class=nx>Speed</span>   <span class=nx>Time</span>    <span class=nx>Time</span>     <span class=nx>Time</span>  <span class=nx>Current</span>
                                 <span class=nx>Dload</span>  <span class=nx>Upload</span>   <span class=nx>Total</span>   <span class=nx>Spent</span>    <span class=nx>Left</span>  <span class=nx>Speed</span>
<span class=mi>100</span>  <span class=mi>1167</span>  <span class=mi>100</span>  <span class=mi>1167</span>    <span class=mi>0</span>     <span class=mi>0</span>   <span class=mi>393</span><span class=nx>k</span>      <span class=mi>0</span> <span class=o>--:--:--</span> <span class=o>--:--:--</span> <span class=o>--:--:--</span>  <span class=mi>569</span><span class=nx>k</span>
<span class=p>{</span>
  <span class=s2>&#34;kind&#34;</span><span class=o>:</span> <span class=s2>&#34;NodeMetricsList&#34;</span><span class=p>,</span>
  <span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span> <span class=s2>&#34;metrics.k8s.io/v1beta1&#34;</span><span class=p>,</span>
  <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;selfLink&#34;</span><span class=o>:</span> <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/nodes&#34;</span>
  <span class=p>},</span>
  <span class=s2>&#34;items&#34;</span><span class=o>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;node-3&#34;</span><span class=p>,</span>
        <span class=s2>&#34;selfLink&#34;</span><span class=o>:</span> <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/nodes/node-3&#34;</span><span class=p>,</span>
        <span class=s2>&#34;creationTimestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:23:00Z&#34;</span>
      <span class=p>},</span>
      <span class=s2>&#34;timestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:22:07Z&#34;</span><span class=p>,</span>
      <span class=s2>&#34;window&#34;</span><span class=o>:</span> <span class=s2>&#34;30s&#34;</span><span class=p>,</span>
      <span class=s2>&#34;usage&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;cpu&#34;</span><span class=o>:</span> <span class=s2>&#34;32868032n&#34;</span><span class=p>,</span>
        <span class=s2>&#34;memory&#34;</span><span class=o>:</span> <span class=s2>&#34;1027108Ki&#34;</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;node-1&#34;</span><span class=p>,</span>
        <span class=s2>&#34;selfLink&#34;</span><span class=o>:</span> <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/nodes/node-1&#34;</span><span class=p>,</span>
        <span class=s2>&#34;creationTimestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:23:00Z&#34;</span>
      <span class=p>},</span>
      <span class=s2>&#34;timestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:22:07Z&#34;</span><span class=p>,</span>
      <span class=s2>&#34;window&#34;</span><span class=o>:</span> <span class=s2>&#34;30s&#34;</span><span class=p>,</span>
      <span class=s2>&#34;usage&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;cpu&#34;</span><span class=o>:</span> <span class=s2>&#34;108639556n&#34;</span><span class=p>,</span>
        <span class=s2>&#34;memory&#34;</span><span class=o>:</span> <span class=s2>&#34;4305356Ki&#34;</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;node-2&#34;</span><span class=p>,</span>
        <span class=s2>&#34;selfLink&#34;</span><span class=o>:</span> <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/nodes/node-2&#34;</span><span class=p>,</span>
        <span class=s2>&#34;creationTimestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:23:00Z&#34;</span>
      <span class=p>},</span>
      <span class=s2>&#34;timestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:22:12Z&#34;</span><span class=p>,</span>
      <span class=s2>&#34;window&#34;</span><span class=o>:</span> <span class=s2>&#34;30s&#34;</span><span class=p>,</span>
      <span class=s2>&#34;usage&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;cpu&#34;</span><span class=o>:</span> <span class=s2>&#34;47607386n&#34;</span><span class=p>,</span>
        <span class=s2>&#34;memory&#34;</span><span class=o>:</span> <span class=s2>&#34;1119960Ki&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>

<span class=nx>c</span><span class=err>、</span><span class=nx>指定某个具体的node访问到具体node的资源监控数据</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/nodes/node-2
</span><span class=c1></span><span class=p>{</span>
  <span class=s2>&#34;kind&#34;</span><span class=o>:</span> <span class=s2>&#34;NodeMetrics&#34;</span><span class=p>,</span>
  <span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span> <span class=s2>&#34;metrics.k8s.io/v1beta1&#34;</span><span class=p>,</span>
  <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;node-2&#34;</span><span class=p>,</span>
    <span class=s2>&#34;selfLink&#34;</span><span class=o>:</span> <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/nodes/node-2&#34;</span><span class=p>,</span>
    <span class=s2>&#34;creationTimestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:24:39Z&#34;</span>
  <span class=p>},</span>
  <span class=s2>&#34;timestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:24:12Z&#34;</span><span class=p>,</span>
  <span class=s2>&#34;window&#34;</span><span class=o>:</span> <span class=s2>&#34;30s&#34;</span><span class=p>,</span>
  <span class=s2>&#34;usage&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;cpu&#34;</span><span class=o>:</span> <span class=s2>&#34;43027609n&#34;</span><span class=p>,</span>
    <span class=s2>&#34;memory&#34;</span><span class=o>:</span> <span class=s2>&#34;1120168Ki&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nx>d</span><span class=err>、</span><span class=nx>查看所有pod的列表信息</span>
<span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/pods
</span><span class=c1></span>
<span class=nx>e</span><span class=err>、</span><span class=nx>查看某个具体pod的监控数据</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//127.0.0.1:8001/apis/metrics.k8s.io/v1beta1/namespaces/default/pods/haproxy-ingress-demo-5d487d4fc-sr8tm
</span><span class=c1></span><span class=p>{</span>
  <span class=s2>&#34;kind&#34;</span><span class=o>:</span> <span class=s2>&#34;PodMetrics&#34;</span><span class=p>,</span>
  <span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span> <span class=s2>&#34;metrics.k8s.io/v1beta1&#34;</span><span class=p>,</span>
  <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;haproxy-ingress-demo-5d487d4fc-sr8tm&#34;</span><span class=p>,</span>
    <span class=s2>&#34;namespace&#34;</span><span class=o>:</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>
    <span class=s2>&#34;selfLink&#34;</span><span class=o>:</span> <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/namespaces/default/pods/haproxy-ingress-demo-5d487d4fc-sr8tm&#34;</span><span class=p>,</span>
    <span class=s2>&#34;creationTimestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:36:30Z&#34;</span>
  <span class=p>},</span>
  <span class=s2>&#34;timestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:36:13Z&#34;</span><span class=p>,</span>
  <span class=s2>&#34;window&#34;</span><span class=o>:</span> <span class=s2>&#34;30s&#34;</span><span class=p>,</span>
  <span class=s2>&#34;containers&#34;</span><span class=o>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;haproxy-ingress-demo&#34;</span><span class=p>,</span>
      <span class=s2>&#34;usage&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;cpu&#34;</span><span class=o>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
        <span class=s2>&#34;memory&#34;</span><span class=o>:</span> <span class=s2>&#34;1428Ki&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>5、当然也可以通过kubectl -raw的方式访问接口,如调用node-3的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=o>--</span><span class=nx>raw</span> <span class=o>/</span><span class=nx>apis</span><span class=o>/</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>v1beta1</span><span class=o>/</span><span class=nx>nodes</span><span class=o>/</span><span class=nx>node</span><span class=o>-</span><span class=mi>3</span> <span class=o>|</span> <span class=nx>jq</span> <span class=p>.</span>
<span class=p>{</span>
  <span class=s2>&#34;kind&#34;</span><span class=o>:</span> <span class=s2>&#34;NodeMetrics&#34;</span><span class=p>,</span>
  <span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span> <span class=s2>&#34;metrics.k8s.io/v1beta1&#34;</span><span class=p>,</span>
  <span class=s2>&#34;metadata&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;node-3&#34;</span><span class=p>,</span>
    <span class=s2>&#34;selfLink&#34;</span><span class=o>:</span> <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/nodes/node-3&#34;</span><span class=p>,</span>
    <span class=s2>&#34;creationTimestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:44:46Z&#34;</span>
  <span class=p>},</span>
  <span class=s2>&#34;timestamp&#34;</span><span class=o>:</span> <span class=s2>&#34;2019-12-30T14:44:09Z&#34;</span><span class=p>,</span>
  <span class=s2>&#34;window&#34;</span><span class=o>:</span> <span class=s2>&#34;30s&#34;</span><span class=p>,</span>
  <span class=s2>&#34;usage&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;cpu&#34;</span><span class=o>:</span> <span class=s2>&#34;35650151n&#34;</span><span class=p>,</span>
    <span class=s2>&#34;memory&#34;</span><span class=o>:</span> <span class=s2>&#34;1026820Ki&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>其他近似的接口有：</p><p>kubectl get &ndash;raw /apis/metrics.k8s.io/v1beta1/nodes 获取所有node的数据</p><p>kubectl get &ndash;raw /apis/metrics.k8s.io/v1beta1/nodes/&lt;node_name> 获取特定node数据</p><p>kubectl get &ndash;raw /apis/metrics.k8s.io/v1beta1/pods 获取所有pod的数据</p><p>kubectl get &ndash;raw /apis/metrics.k8s.io/v1beta1/namespaces/default/pods/haproxy-ingress-demo-5d487d4fc-sr8tm 获取某个特定pod的数据</p><h1 id=3-hpa水平横向动态扩展>3. HPA水平横向动态扩展</h1><h2 id=31-hpa概述>3.1 HPA概述</h2><blockquote><p>The Horizontal Pod Autoscaler automatically scales the number of pods in a replication controller, deployment, replica set or stateful set based on observed CPU utilization (or, with custom metrics support, on some other application-provided metrics). Note that Horizontal Pod Autoscaling does not apply to objects that can’t be scaled, for example, DaemonSets.</p></blockquote><p><img src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B9%9D)%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9HPA%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/5%20-%201620.jpg alt=水平横向扩展></p><p>HPA即Horizontal Pod Autoscaler,Pod水平横向动态扩展，即根据应用分配资源使用情况，动态增加或者减少Pod副本数量，以实现集群资源的扩容，其实现机制为：</p><ul><li>HPA需要依赖于监控组件，调用监控数据实现动态伸缩，如调用Metrics API接口</li><li>HPA是二级的副本控制器，建立在Deployments，ReplicaSet，StatefulSets等副本控制器基础之上</li><li>HPA根据获取资源指标不同支持两个版本：v1和v2alpha1</li><li>HPA V1获取核心资源指标，如CPU和内存利用率，通过调用Metric-server API接口实现</li><li>HPA V2获取自定义监控指标，通过Prometheus获取监控数据实现</li><li>HPA根据资源API周期性调整副本数，检测周期horizontal-pod-autoscaler-sync-period定义的值，默认15s</li></ul><h2 id=32-hpa实现>3.2 HPA实现</h2><p>如下开始延时HPA功能的实现，先创建一个Deployment副本控制器，然后再通过HPA定义资源度量策略，当CPU利用率超过requests分配的80%时即扩容。</p><p>1、创建Deployment副本控制器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>run</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span> <span class=o>--</span><span class=nx>image</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span> <span class=o>--</span><span class=nx>port</span><span class=o>=</span><span class=mi>80</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>1</span> <span class=o>--</span><span class=nx>expose</span><span class=o>=</span><span class=kc>true</span> <span class=o>--</span><span class=nx>requests</span><span class=o>=</span><span class=s2>&#34;&#39;cpu=200m,memory=64Mi&#34;</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>yaml</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Deployment</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>deployment</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>revision</span><span class=o>:</span> <span class=s2>&#34;1&#34;</span>
  <span class=nx>creationTimestamp</span><span class=o>:</span> <span class=s2>&#34;2019-12-31T01:43:24Z&#34;</span>
  <span class=nx>generation</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>run</span><span class=o>:</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=k>default</span>
  <span class=nx>resourceVersion</span><span class=o>:</span> <span class=s2>&#34;14451208&#34;</span>
  <span class=nx>selfLink</span><span class=o>:</span> <span class=err>/apis/extensions/v1beta1/namespaces/default/deployments/hpa-demo</span>
  <span class=nx>uid</span><span class=o>:</span> <span class=mi>3</span><span class=nx>b0f29e8</span><span class=o>-</span><span class=mi>8606</span><span class=o>-</span><span class=mi>4</span><span class=nx>e52</span><span class=o>-</span><span class=mi>8</span><span class=nx>f5b</span><span class=o>-</span><span class=mi>6</span><span class=nx>c960d396136</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>progressDeadlineSeconds</span><span class=o>:</span> <span class=mi>600</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>revisionHistoryLimit</span><span class=o>:</span> <span class=mi>10</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>run</span><span class=o>:</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>strategy</span><span class=o>:</span>
    <span class=nx>rollingUpdate</span><span class=o>:</span>
      <span class=nx>maxSurge</span><span class=o>:</span> <span class=mi>25</span><span class=o>%</span>
      <span class=nx>maxUnavailable</span><span class=o>:</span> <span class=mi>25</span><span class=o>%</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>RollingUpdate</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>creationTimestamp</span><span class=o>:</span> <span class=kc>null</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>run</span><span class=o>:</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
        <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
          <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
        <span class=nx>resources</span><span class=o>:</span> 
          <span class=nx>requests</span><span class=o>:</span>
            <span class=nx>cpu</span><span class=o>:</span> <span class=mi>200</span><span class=nx>m</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>64</span><span class=nx>Mi</span>
        <span class=nx>terminationMessagePath</span><span class=o>:</span> <span class=err>/dev/termination-log</span>
        <span class=nx>terminationMessagePolicy</span><span class=o>:</span> <span class=nx>File</span>
      <span class=nx>dnsPolicy</span><span class=o>:</span> <span class=nx>ClusterFirst</span>
      <span class=nx>restartPolicy</span><span class=o>:</span> <span class=nx>Always</span>
      <span class=nx>schedulerName</span><span class=o>:</span> <span class=k>default</span><span class=o>-</span><span class=nx>scheduler</span>
      <span class=nx>securityContext</span><span class=o>:</span> <span class=p>{}</span>
      <span class=nx>terminationGracePeriodSeconds</span><span class=o>:</span> <span class=mi>30</span>
<span class=nx>status</span><span class=o>:</span>
  <span class=nx>availableReplicas</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>conditions</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>lastTransitionTime</span><span class=o>:</span> <span class=s2>&#34;2019-12-31T01:43:25Z&#34;</span>
    <span class=nx>lastUpdateTime</span><span class=o>:</span> <span class=s2>&#34;2019-12-31T01:43:25Z&#34;</span>
    <span class=nx>message</span><span class=o>:</span> <span class=nx>Deployment</span> <span class=nx>has</span> <span class=nx>minimum</span> <span class=nx>availability</span><span class=p>.</span>
    <span class=nx>reason</span><span class=o>:</span> <span class=nx>MinimumReplicasAvailable</span>
    <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;True&#34;</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>Available</span>
  <span class=o>-</span> <span class=nx>lastTransitionTime</span><span class=o>:</span> <span class=s2>&#34;2019-12-31T01:43:24Z&#34;</span>
    <span class=nx>lastUpdateTime</span><span class=o>:</span> <span class=s2>&#34;2019-12-31T01:43:25Z&#34;</span>
    <span class=nx>message</span><span class=o>:</span> <span class=nx>ReplicaSet</span> <span class=s2>&#34;hpa-demo-755bdd875c&#34;</span> <span class=nx>has</span> <span class=nx>successfully</span> <span class=nx>progressed</span><span class=p>.</span>
    <span class=nx>reason</span><span class=o>:</span> <span class=nx>NewReplicaSetAvailable</span>
    <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;True&#34;</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>Progressing</span>
  <span class=nx>observedGeneration</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>readyReplicas</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>1</span>
  <span class=nx>updatedReplicas</span><span class=o>:</span> <span class=mi>1</span>
</code></pre></td></tr></table></div></div><p>2、创建HPA控制器，基于CPU实现横向扩展,策略为至少2个Pod，最大5个，targetCPUUtilizationPercentage表示CPU实际使用率占requests百分比</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>autoscaling</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>HorizontalPodAutoscaler</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>maxReplicas</span><span class=o>:</span> <span class=mi>5</span>
  <span class=nx>minReplicas</span><span class=o>:</span> <span class=mi>2</span>
  <span class=nx>scaleTargetRef</span><span class=o>:</span>
    <span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
    <span class=nx>kind</span><span class=o>:</span> <span class=nx>Deployment</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>targetCPUUtilizationPercentage</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></td></tr></table></div></div><p>3、应用HPA规则并查看详情，由于策略需确保最小2个副本，Deployment默认不是2个副本，因此需要扩容，在详情日志中看到副本扩展至2个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>horizontalpodautoscaler</span><span class=p>.</span><span class=nx>autoscaling</span><span class=o>/</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>

<span class=err>#</span><span class=nx>查看HPA列表</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>horizontalpodautoscalers</span><span class=p>.</span><span class=nx>autoscaling</span> 
<span class=nx>NAME</span>       <span class=nx>REFERENCE</span>             <span class=nx>TARGETS</span>         <span class=nx>MINPODS</span>   <span class=nx>MAXPODS</span>   <span class=nx>REPLICAS</span>   <span class=nx>AGE</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>   <span class=nx>Deployment</span><span class=o>/</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>   <span class=o>&lt;</span><span class=nx>unknown</span><span class=o>&gt;</span><span class=err>/80%   2         5         0          7s</span>

<span class=err>#</span><span class=nx>查看HPA详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>horizontalpodautoscalers</span><span class=p>.</span><span class=nx>autoscaling</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>                                                  <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>                                             <span class=k>default</span>
<span class=nx>Labels</span><span class=o>:</span>                                                <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Annotations</span><span class=o>:</span>                                           <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                                                         <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;autoscaling/v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;HorizontalPodAutoscaler&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;hpa-demo&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=err>&#34;</span><span class=nx>spe</span><span class=p>...</span>
<span class=nx>CreationTimestamp</span><span class=o>:</span>                                     <span class=nx>Tue</span><span class=p>,</span> <span class=mi>31</span> <span class=nx>Dec</span> <span class=mi>2019</span> <span class=mi>09</span><span class=o>:</span><span class=mi>52</span><span class=o>:</span><span class=mi>51</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Reference</span><span class=o>:</span>                                             <span class=nx>Deployment</span><span class=o>/</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Metrics</span><span class=o>:</span>                                               <span class=p>(</span> <span class=nx>current</span> <span class=o>/</span> <span class=nx>target</span> <span class=p>)</span>
  <span class=nx>resource</span> <span class=nx>cpu</span> <span class=nx>on</span> <span class=nx>pods</span>  <span class=p>(</span><span class=nx>as</span> <span class=nx>a</span> <span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>unknown</span><span class=o>&gt;</span> <span class=err>/ 80%</span>
<span class=nx>Min</span> <span class=nx>replicas</span><span class=o>:</span>                                          <span class=mi>2</span>
<span class=nx>Max</span> <span class=nx>replicas</span><span class=o>:</span>                                          <span class=mi>5</span>
<span class=nx>Deployment</span> <span class=nx>pods</span><span class=o>:</span>                                       <span class=mi>1</span> <span class=nx>current</span> <span class=o>/</span> <span class=mi>2</span> <span class=nx>desired</span>
<span class=nx>Conditions</span><span class=o>:</span>
  <span class=nx>Type</span>         <span class=nx>Status</span>  <span class=nx>Reason</span>            <span class=nx>Message</span>
  <span class=o>----</span>         <span class=o>------</span>  <span class=o>------</span>            <span class=o>-------</span>
  <span class=nx>AbleToScale</span>  <span class=nx>True</span>    <span class=nx>SucceededRescale</span>  <span class=nx>the</span> <span class=nx>HPA</span> <span class=nx>controller</span> <span class=nx>was</span> <span class=nx>able</span> <span class=nx>to</span> <span class=nx>update</span> <span class=nx>the</span> <span class=nx>target</span> <span class=nx>scale</span> <span class=nx>to</span> <span class=mi>2</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>             <span class=nx>Age</span>   <span class=nx>From</span>                       <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>             <span class=o>----</span>  <span class=o>----</span>                       <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>SuccessfulRescale</span>  <span class=mi>1</span><span class=nx>s</span>    <span class=nx>horizontal</span><span class=o>-</span><span class=nx>pod</span><span class=o>-</span><span class=nx>autoscaler</span>  <span class=nx>New</span> <span class=nx>size</span><span class=o>:</span> <span class=mi>2</span><span class=p>;</span> <span class=nx>reason</span><span class=o>:</span> <span class=nx>Current</span> <span class=nx>number</span> <span class=k>of</span> <span class=nx>replicas</span> <span class=nx>below</span> <span class=nx>Spec</span><span class=p>.</span><span class=nx>MinReplicas</span> <span class=err>#</span><span class=nx>副本扩容至2个</span><span class=err>，</span><span class=nx>根据MinReplica的策略</span>
</code></pre></td></tr></table></div></div><p>4、查看Deployment列表校验确认扩容情况，已达到HPA基础最小化策略</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>  <span class=o>--</span><span class=nx>show</span><span class=o>-</span><span class=nx>labels</span> 
<span class=nx>NAME</span>       <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>   <span class=nx>LABELS</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>2</span><span class=o>/</span><span class=mi>2</span>     <span class=mi>2</span>            <span class=mi>2</span>           <span class=mi>94</span><span class=nx>m</span>   <span class=nx>run</span><span class=o>=</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>l</span> <span class=nx>run</span><span class=o>=</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>NAME</span>                        <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=mi>7</span><span class=nx>q4td</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>5</span><span class=nx>m10s</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>cq6k6</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>10</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>5、假如业务增长期间，CPU利用率增高，会自动横向增加Pod来实现，下面开始通过CPU压测来演示Deployment的扩展</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>exec</span> <span class=o>-</span><span class=nx>it</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>cq6k6</span>  <span class=o>/</span><span class=nx>bin</span><span class=o>/</span><span class=nx>bash</span>
<span class=nx>root</span><span class=err>@</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>cq6k6</span><span class=o>:</span><span class=err>/#  dd if=/dev/zero of=/dev/null </span>

<span class=nx>再次查看HPA的日志</span><span class=err>，</span><span class=nx>提示已扩容</span><span class=err>，</span><span class=nx>原因是cpu</span> <span class=nx>resource</span> <span class=nx>utilization</span> <span class=p>(</span><span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span> <span class=nx>above</span> <span class=nx>target</span><span class=err>，</span><span class=nx>即CPU资源利用率超过requests设置的百分比</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>horizontalpodautoscalers</span><span class=p>.</span><span class=nx>autoscaling</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>                                                  <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>                                             <span class=k>default</span>
<span class=nx>Labels</span><span class=o>:</span>                                                <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Annotations</span><span class=o>:</span>                                           <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                                                         <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;autoscaling/v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;HorizontalPodAutoscaler&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;hpa-demo&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=err>&#34;</span><span class=nx>spe</span><span class=p>...</span>
<span class=nx>CreationTimestamp</span><span class=o>:</span>                                     <span class=nx>Tue</span><span class=p>,</span> <span class=mi>31</span> <span class=nx>Dec</span> <span class=mi>2019</span> <span class=mi>09</span><span class=o>:</span><span class=mi>52</span><span class=o>:</span><span class=mi>51</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Reference</span><span class=o>:</span>                                             <span class=nx>Deployment</span><span class=o>/</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Metrics</span><span class=o>:</span>                                               <span class=p>(</span> <span class=nx>current</span> <span class=o>/</span> <span class=nx>target</span> <span class=p>)</span>
  <span class=nx>resource</span> <span class=nx>cpu</span> <span class=nx>on</span> <span class=nx>pods</span>  <span class=p>(</span><span class=nx>as</span> <span class=nx>a</span> <span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span><span class=o>:</span>  <span class=mi>99</span><span class=o>%</span> <span class=p>(</span><span class=mi>199</span><span class=nx>m</span><span class=p>)</span> <span class=o>/</span> <span class=mi>80</span><span class=o>%</span>
<span class=nx>Min</span> <span class=nx>replicas</span><span class=o>:</span>                                          <span class=mi>2</span>
<span class=nx>Max</span> <span class=nx>replicas</span><span class=o>:</span>                                          <span class=mi>5</span>
<span class=nx>Deployment</span> <span class=nx>pods</span><span class=o>:</span>                                       <span class=mi>5</span> <span class=nx>current</span> <span class=o>/</span> <span class=mi>5</span> <span class=nx>desired</span>
<span class=nx>Conditions</span><span class=o>:</span>
  <span class=nx>Type</span>            <span class=nx>Status</span>  <span class=nx>Reason</span>            <span class=nx>Message</span>
  <span class=o>----</span>            <span class=o>------</span>  <span class=o>------</span>            <span class=o>-------</span>
  <span class=nx>AbleToScale</span>     <span class=nx>True</span>    <span class=nx>ReadyForNewScale</span>  <span class=nx>recommended</span> <span class=nx>size</span> <span class=nx>matches</span> <span class=nx>current</span> <span class=nx>size</span>
  <span class=nx>ScalingActive</span>   <span class=nx>True</span>    <span class=nx>ValidMetricFound</span>  <span class=nx>the</span> <span class=nx>HPA</span> <span class=nx>was</span> <span class=nx>able</span> <span class=nx>to</span> <span class=nx>successfully</span> <span class=nx>calculate</span> <span class=nx>a</span> <span class=nx>replica</span> <span class=nx>count</span> <span class=nx>from</span> <span class=nx>cpu</span> <span class=nx>resource</span> <span class=nx>utilization</span> <span class=p>(</span><span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span>
  <span class=nx>ScalingLimited</span>  <span class=nx>True</span>    <span class=nx>TooManyReplicas</span>   <span class=nx>the</span> <span class=nx>desired</span> <span class=nx>replica</span> <span class=nx>count</span> <span class=nx>is</span> <span class=nx>more</span> <span class=nx>than</span> <span class=nx>the</span> <span class=nx>maximum</span> <span class=nx>replica</span> <span class=nx>count</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>     <span class=nx>Reason</span>                   <span class=nx>Age</span>                   <span class=nx>From</span>                       <span class=nx>Message</span>
  <span class=o>----</span>     <span class=o>------</span>                   <span class=o>----</span>                  <span class=o>----</span>                       <span class=o>-------</span>
  <span class=nx>Normal</span>   <span class=nx>SuccessfulRescale</span>        <span class=mi>8</span><span class=nx>m2s</span>                  <span class=nx>horizontal</span><span class=o>-</span><span class=nx>pod</span><span class=o>-</span><span class=nx>autoscaler</span>  <span class=nx>New</span> <span class=nx>size</span><span class=o>:</span> <span class=mi>4</span><span class=p>;</span> <span class=nx>reason</span><span class=o>:</span> <span class=nx>cpu</span> <span class=nx>resource</span> <span class=nx>utilization</span> <span class=p>(</span><span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span> <span class=nx>above</span> <span class=nx>target</span>

<span class=nx>查看副本的个数</span><span class=err>，</span><span class=nx>确认扩容情况</span><span class=err>，</span><span class=nx>已成功扩容至5个</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> 
<span class=nx>NAME</span>                                   <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=mi>7</span><span class=nx>q4td</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>16</span><span class=nx>m</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>cq6k6</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>21</span><span class=nx>m</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>jmb6w</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>16</span><span class=nx>m</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>lpxk8</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>16</span><span class=nx>m</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>zs6cg</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>21</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>6、停止CPU压测业务，HPA会自定缩减Pod的副本个数，直至满足条件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>horizontalpodautoscalers</span><span class=p>.</span><span class=nx>autoscaling</span> <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Name</span><span class=o>:</span>                                                  <span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>                                             <span class=k>default</span>
<span class=nx>Labels</span><span class=o>:</span>                                                <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Annotations</span><span class=o>:</span>                                           <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                                                         <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;autoscaling/v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;HorizontalPodAutoscaler&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;hpa-demo&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=err>&#34;</span><span class=nx>spe</span><span class=p>...</span>
<span class=nx>CreationTimestamp</span><span class=o>:</span>                                     <span class=nx>Tue</span><span class=p>,</span> <span class=mi>31</span> <span class=nx>Dec</span> <span class=mi>2019</span> <span class=mi>09</span><span class=o>:</span><span class=mi>52</span><span class=o>:</span><span class=mi>51</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Reference</span><span class=o>:</span>                                             <span class=nx>Deployment</span><span class=o>/</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Metrics</span><span class=o>:</span>                                               <span class=p>(</span> <span class=nx>current</span> <span class=o>/</span> <span class=nx>target</span> <span class=p>)</span>
  <span class=nx>resource</span> <span class=nx>cpu</span> <span class=nx>on</span> <span class=nx>pods</span>  <span class=p>(</span><span class=nx>as</span> <span class=nx>a</span> <span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span><span class=o>:</span>  <span class=mi>0</span><span class=o>%</span> <span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=mi>80</span><span class=o>%</span>
<span class=nx>Min</span> <span class=nx>replicas</span><span class=o>:</span>                                          <span class=mi>2</span>
<span class=nx>Max</span> <span class=nx>replicas</span><span class=o>:</span>                                          <span class=mi>5</span>
<span class=nx>Deployment</span> <span class=nx>pods</span><span class=o>:</span>                                       <span class=mi>2</span> <span class=nx>current</span> <span class=o>/</span> <span class=mi>2</span> <span class=nx>desired</span>
<span class=nx>Conditions</span><span class=o>:</span>
  <span class=nx>Type</span>            <span class=nx>Status</span>  <span class=nx>Reason</span>            <span class=nx>Message</span>
  <span class=o>----</span>            <span class=o>------</span>  <span class=o>------</span>            <span class=o>-------</span>
  <span class=nx>AbleToScale</span>     <span class=nx>True</span>    <span class=nx>ReadyForNewScale</span>  <span class=nx>recommended</span> <span class=nx>size</span> <span class=nx>matches</span> <span class=nx>current</span> <span class=nx>size</span>
  <span class=nx>ScalingActive</span>   <span class=nx>True</span>    <span class=nx>ValidMetricFound</span>  <span class=nx>the</span> <span class=nx>HPA</span> <span class=nx>was</span> <span class=nx>able</span> <span class=nx>to</span> <span class=nx>successfully</span> <span class=nx>calculate</span> <span class=nx>a</span> <span class=nx>replica</span> <span class=nx>count</span> <span class=nx>from</span> <span class=nx>cpu</span> <span class=nx>resource</span> <span class=nx>utilization</span> <span class=p>(</span><span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span>
  <span class=nx>ScalingLimited</span>  <span class=nx>True</span>    <span class=nx>TooFewReplicas</span>    <span class=nx>the</span> <span class=nx>desired</span> <span class=nx>replica</span> <span class=nx>count</span> <span class=nx>is</span> <span class=nx>increasing</span> <span class=nx>faster</span> <span class=nx>than</span> <span class=nx>the</span> <span class=nx>maximum</span> <span class=nx>scale</span> <span class=nx>rate</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>     <span class=nx>Reason</span>                   <span class=nx>Age</span>                   <span class=nx>From</span>                       <span class=nx>Message</span>
  <span class=o>----</span>     <span class=o>------</span>                   <span class=o>----</span>                  <span class=o>----</span>                       <span class=o>-------</span>
  <span class=nx>Normal</span>   <span class=nx>SuccessfulRescale</span>        <span class=mi>18</span><span class=nx>m</span>                   <span class=nx>horizontal</span><span class=o>-</span><span class=nx>pod</span><span class=o>-</span><span class=nx>autoscaler</span>  <span class=nx>New</span> <span class=nx>size</span><span class=o>:</span> <span class=mi>4</span><span class=p>;</span> <span class=nx>reason</span><span class=o>:</span> <span class=nx>cpu</span> <span class=nx>resource</span> <span class=nx>utilization</span> <span class=p>(</span><span class=nx>percentage</span> <span class=k>of</span> <span class=nx>request</span><span class=p>)</span> <span class=nx>above</span> <span class=nx>target</span>
  <span class=nx>Normal</span>   <span class=nx>SuccessfulRescale</span>        <span class=mi>113</span><span class=nx>s</span>                  <span class=nx>horizontal</span><span class=o>-</span><span class=nx>pod</span><span class=o>-</span><span class=nx>autoscaler</span>  <span class=nx>New</span> <span class=nx>size</span><span class=o>:</span> <span class=mi>2</span><span class=p>;</span> <span class=nx>reason</span><span class=o>:</span> <span class=nx>All</span> <span class=nx>metrics</span> <span class=nx>below</span> <span class=nx>target</span>   <span class=err>#</span><span class=nx>缩减至2个pod副本</span>

<span class=nx>确认副本的个数</span><span class=err>，</span><span class=nx>已缩减至最小数量2个</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>l</span> <span class=nx>run</span><span class=o>=</span><span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>NAME</span>                        <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>cq6k6</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>24</span><span class=nx>m</span>
<span class=nx>hpa</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>fcd9c757d</span><span class=o>-</span><span class=nx>zs6cg</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>24</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>通过上面的例子可以知道，HPA可以基于metric-server提供的API监控数据实现水平动态弹性扩展的需求，从而可以根据业务CPU使用情况，动态水平横向扩展，保障业务的可用性。当前HPA V1扩展使用指标只能基于CPU分配使用率进行扩展，功能相对有限，更丰富的功能需要由HPA V2版来实现，其由不同的API来实现：</p><ul><li>metrics.k8s.io 资源指标API，通过metric-server提供，提供node和pod的cpu，内存资源查询；</li><li>custom.metrics.k8s.io 自定义指标，通过adapter和kube-apiserver集成，如promethues；</li><li>external.metrics.k8s.io 外部指标，和自定义指标类似，需要通过adapter和k8s集成。</li></ul><h1 id=参考文献>参考文献</h1><p>资源指标说明：https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/</p><p>部署官方说明：https://github.com/kubernetes-sigs/metrics-server</p><p>(<a href=https://github.com/kubernetes-sigs/metrics-server>https://github.com/kubernetes-sigs/metrics-server</a>)</p><blockquote><p>『 转载 』该文章来源于网络，侵删。</p></blockquote></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content><a href=https://agou-ops.cn/author/agou-ops/>AGou-ops</a></span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2019-08-04</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a href=http://www.wtfpl.net/about/ rel=noopener target=_blank>WTFPL v2</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>Want To Reward Me?</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/wechat.png>
<span>Wechat</span></label>
<label class=qr-code-image for=reward><img class=image src=https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/alipay.png>
<span>Alipay</span></label></div></div><footer class=post-footer><div class=post-tags><a href=https://agou-ops.cn/tags/kubernetes/>kubernetes</a></div><nav class=post-nav><a class=prev href=/post/k8s/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg></i><span class="prev-text nav-default">16 基于haproxy实现ingress服务暴露</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/k8s/18-prometheus%E6%8F%90%E4%BE%9B%E5%AE%8C%E5%A4%87%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/><span class="next-text nav-default">18 Prometheus提供完备监控系统</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"/></svg></i></a></nav></footer></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=AGou-ops/comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:agou-ops@foxmail.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408 1361.641813S1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523L83.726336 1024H682.532949 753.579947 1348.948139L1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955C777.248 802.205449 742.347691 811.03081 718.063616 811.603883z"/></svg></a><a href=https://space.bilibili.com/283008785 rel="me noopener" class=iconfont title=bilibili target=_blank><svg class="icon" viewBox="0 0 1024 1024" width="36" height="36" id="svg8"><path d="M744.60599.00486267A41.779915 41.779915.0 00710.4184 18.673394L548.5048 255.32642h-11.70046a41.779915 41.779915.0 00-10.80295-7.84928L235.66 97.084498a41.779915 41.779915.0 00-20.07193-4.960864 41.779915 41.779915.0 00-18.3748 79.145436L359.4859 255.32642H128.16909c-49.458302.0-89.27932 39.82105-89.27932 89.27932v508.65224c0 49.4583 39.821018 89.27934 89.27932 89.27934h19.48445C149.12802 984.5043 179.92773 1024 224.79179 1024c44.86407.0 75.66379-39.4957 77.13826-81.46268H719.98116C721.45559 984.5043 752.25533 1024 797.1194 1024c44.86406.0 75.6638-39.4957 77.13824-81.46268h21.57323c49.45831.0 89.27936-39.82104 89.27936-89.27934V344.60574c0-49.45827-39.82105-89.27932-89.27936-89.27932H649.74567L779.38103 65.866924A41.779915 41.779915.0 00744.60599.00486267zM644.49108 418.70871c6.29985.21538 12.44451 2.01107 17.86888 5.22196l171.36218 98.10771c18.23417 10.21935 24.63334 33.34627 14.24614 51.48533-10.38726 18.13909-33.57344 24.32718-51.61587 13.77296L624.9903 489.18895c-15.21356-8.41858-22.66871-26.1765-18.03211-42.93436 4.63664-16.75784 20.15573-28.14465 37.53289-27.54588zM350.2006 432.31846c16.89952.0317 31.69582 11.33328 36.17844 27.62747 4.48262 16.2942-2.44981 33.57765-16.95507 42.24898l-140.7157 86.91312c-17.68528 11.18244-41.09629 5.77692-52.08912-12.02686-10.99282-17.80373-5.33855-41.15658 12.58167-51.95857L329.9002 438.2095c6.0643-3.86439 13.10951-5.90891 20.3004-5.89104zM501.605 641.53985c3.75002-.15248 7.48645.53903 10.93349 2.0235.15842.0637.31618.12888.47325.19582.59328.27092 1.17574.56489 1.74609.88121.15868.0854.31643.17233.47325.2611.55694.32165 1.10131.66458 1.63185 1.02807.16455.1123.32777.2265.48956.34269.50382.36781.99371.75428 1.46868 1.15864.18724.15504.37218.31282.55484.47323.43271.38784.8518.79061 1.25653 1.20756.15449.16114.30679.32437.45693.48959.40798.44266.79989.89988 1.17494 1.37076.17799.22544.35205.45395.5222.68538.25932.34701.50964.70071.75064 1.06071.26712.39516.52286.79784.76699 1.20757.16907.29043.33231.58424.48957.88123.21836.41297.42513.83199.62009 1.25653.14836.32333.28983.64976.42429.97911.21319.51552.40915 1.03801.58747 1.5666.0677.19499.13296.39085.19582.58748.18652.60823.34984 1.22334.48957 1.84399.0397.16277.0779.32601.11423.48957.1436.69112.25788 1.38801.34269 2.08877.005.0381.0111.0761.0163.11424.0857.78056.13474 1.56471.14687 2.34988.005.0543.0111.10879.0163.1632.0.0-.008 1.12132.0 1.45234.0.0-.14697 17.84761 5.89102 34.12231 3.01902 8.13734 7.33278 15.10615 12.61433 19.61501 5.28157 4.50889 11.42894 7.62081 23.64572 7.62081 12.2168.0 18.36416-3.11192 23.64573-7.62081 5.28154-4.50886 9.5953-11.47767 12.6143-19.61501 6.03799-16.2747 5.89103-34.12231 5.89103-34.12231-.44885-13.87045 10.45922-25.46302 24.3311-25.86506 13.87189-.40201 25.42828 10.53953 25.78348 24.41272.0.0 1.11929 25.7226-9.00791 53.01927-5.06359 13.64832-13.1986 28.46036-27.05631 40.29073-13.85772 11.83039-33.5454 19.63135-56.20142 19.63135-22.65603.0-42.34371-7.80096-56.20141-19.63135-4.1801-3.56856-7.78733-7.42433-10.99878-11.42303-3.21235 4.00037-6.81703 7.85309-10.99876 11.42303-13.85773 11.83039-33.5454 19.63135-56.20144 19.63135-22.65601.0-42.3437-7.80096-56.2014-19.63135-13.85775-11.83037-21.99272-26.64241-27.05632-40.29073-10.12725-27.29667-9.00789-53.01928-9.00789-53.01927.20714-13.83687 11.58744-24.88848 25.42444-24.69013 14.1263.19991 25.2971 12.0278 24.69011 26.14247.0.0-.14697 17.84761 5.89103 34.12231 3.01902 8.13734 7.31646 15.10615 12.598 19.61501 5.28155 4.50889 11.44526 7.62081 23.66203 7.62081 12.21681.0 18.36418-3.11192 23.64573-7.62081 5.28154-4.50886 9.57899-11.47767 12.598-19.61501 5.76352-15.53489 5.89112-32.05691 5.89103-33.56746.006-.37466.0111-1.05336.0163-1.20759-.0117-.74583.0105-1.49177.0652-2.23565.009-.15784.0204-.31561.0327-.47324.14204-1.56859.43163-3.12027.86487-4.63449.0213-.0763.0433-.15244.0652-.22848 3.0335-10.25748 12.24157-17.46007 22.92769-17.93417z" id="rect824"/></svg></a><a href=https://www.youtube.com/channel/UCkLgMBY9hnLegjLTulM1guw rel="me noopener" class=iconfont title=youtube target=_blank><svg fill="#000" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="36" height="36"><path fill-rule="evenodd" d="M13 5l3 9v6h2V14l3-9H19l-2 6-2-6zM24 9C22.933594 9 22.410156 9.167969 21.757813 9.703125 21.132813 10.230469 20.960938 10.636719 21 12v5C21 17.996094 21.164063 18.652344 21.765625 19.234375 22.390625 19.816406 22.980469 20 24 20 25.066406 20 25.648438 19.816406 26.25 19.234375 26.875 18.675781 27 17.996094 27 17V12C27 11.117188 26.84375 10.28125 26.238281 9.722656 25.613281 9.148438 24.96875 9 24 9zm5 0v9C29 18.972656 29.980469 20 31 20S32.558594 19.488281 33 19v1h2V9H33v8C32.988281 17.683594 32.183594 18 32 18 31.792969 18 31 17.957031 31 17V9zm-5 2C24.300781 11 25 10.996094 25 12v5C25 17.96875 24.324219 18 24 18 23.699219 18 23 17.988281 23 17V12C23 11.183594 23.433594 11 24 11zM10 22C6.40625 22 4 24.382813 4 28v9.5C4 41.117188 6.40625 44 10 44H40C43.59375 44 46 41.617188 46 38V28C46 24.382813 43.59375 22 40 22zm2 4h6v2H16V40H14V28H12zm14 0h2v4C28.230469 29.640625 28.574219 29.355469 28.902344 29.195313 29.222656 29.03125 29.546875 28.9375 29.875 28.9375 30.523438 28.9375 31.03125 29.171875 31.378906 29.609375 31.726563 30.050781 32 30.636719 32 31.5v6C32 38.242188 31.75 38.703125 31.421875 39.097656 31.101563 39.492188 30.621094 39.992188 30 40 28.949219 40.011719 28.386719 39.449219 28 39v1H26zm-8 3h2v8C20 37.230469 20.269531 38.007813 21 38 21.8125 37.992188 21.820313 37.234375 22 37V29h2V40H22V39C21.628906 39.4375 21.4375 39.574219 21.019531 39.78125 20.605469 40.015625 20.183594 40 19.792969 40 19.308594 40 18.757813 39.5625 18.5 39.234375 18.269531 38.933594 18 38.625 18 38zm18.199219.0C37.148438 29 37.816406 29.203125 38.320313 29.734375 38.835938 30.265625 39 30.886719 39 31.886719V35H35v1.546875C35 37.105469 35.074219 37.460938 35.21875 37.671875 35.355469 37.902344 35.632813 38.003906 36 38 36.40625 37.996094 36.664063 37.914063 36.800781 37.730469 36.941406 37.566406 37 37.101563 37 36.5V36h2v.59375C39 37.683594 38.914063 38.496094 38.375 39.027344 37.867188 39.585938 37.074219 39.84375 36.035156 39.84375 35.085938 39.84375 34.34375 39.5625 33.8125 38.984375S33.003906 37.613281 33.003906 36.59375V31.886719C33.003906 30.980469 33.320313 30.308594 33.902344 29.710938 34.371094 29.230469 35.25 29 36.199219 29zM29 30.5C28.449219 30.5 28.007813 30.996094 28 31.5v6C28.007813 37.789063 28.449219 38 29 38S30 37.574219 30 37.023438V32C30 31 29.550781 30.5 29 30.5zm7 .5C35.449219 31 35.007813 31.464844 35 32v1h2V32C37 31.386719 36.550781 31 36 31z"/></svg></a><a href=https://twitter.com/AgouOps rel="me noopener" class=iconfont title=twitter target=_blank><svg class="icon" viewBox="0 0 1264 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M1229.8616 18.043658s-117.852626 63.135335-164.151872 67.344358c-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"/></svg></a><a href=https://github.com/AGou-ops rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=https://agou-ops.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=copyright-year>&copy;
2018 -
2021
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author>WTFPL</span></span>
<span class=power-by><a title="Host on GitHub & AliOSS"><img alt="Ecologi (Carbon Offset)" src=https://img.shields.io/badge/Host%20on-GitHub%20%26%20AliOSS-blue></a></span>
<span class=theme-info><a title="Provided by Algolia & utteranc"><img alt="Ecologi (Carbon Offset)" src=https://img.shields.io/badge/Providers-Algolia%20%26%20utteranc-brightgreen></a></span></br><span id=busuanzi_container style=font-size:15px>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span></span>
<span><a class=theme-link href=https://beian.miit.gov.cn style=font-size:15px>鲁ICP备19050296号-2</a></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js crossorigin=anonymous></script><script type=text/javascript src=https://cdn.bootcss.com/slideout/1.0.1/slideout.min.js crossorigin=anonymous></script><script type=text/javascript src=/js/main.5807252ad094527cad5c7951a7789078ffbe07989e278d5d65298bfbaa35c615.js integrity crossorigin=anonymous></script><script id=baidu_push>(function(){if(window.location.hostname==='localhost')return;var bp=document.createElement('script');bp.async=true;var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script src=/js/load-photoswipe.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin=anonymous></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:"6a2c773473e3d77a8e761f3f64825c5a",indexName:"main-blog",appId:"5M8VQRD7W9",inputSelector:'.docsearch-input',debug:false,});</script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:"6a2c773473e3d77a8e761f3f64825c5a",indexName:"main-blog",appId:"5M8VQRD7W9",inputSelector:'.docsearch',debug:false,});</script><script src=/js/layer.js></script></body></html>